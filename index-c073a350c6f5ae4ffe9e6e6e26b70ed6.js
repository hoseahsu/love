/* Simple JavaScript Inheritance
 * By John Resig http://ejohn.org/
 * MIT Licensed.
 */
// Inspired by base2 and Prototype
function diff_match_patch(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.prototype.constructor=o,o.extend=arguments.callee,o}})(),"use strict";var Love={init:function(){_.extend(this,AJAXUtil),this.user=__user,this.heartPenAfterLogin(),this.bindToElements()},heartPenAfterLogin:function(){var e=$.cookie("love_cookie"),t=$("#loves_"+e);e&&t.length&&($.cookie("love_cookie",null),this.sendLove(e,this.getNextLoveType(t)))},bindToElements:function(){$("#heart-this")._on("click",this.heartPenInEditor,this),$("body").on("click","a.loves",$.proxy(this.boundToHeartPenInGrid,this)),$("body").on("click","a.comment-heart",$.proxy(this.boundToHeartComment,this))},boundToHeartPenInGrid:function(e){e.preventDefault(),this.heartPenInGrid(e,$(e.target))},boundToHeartComment:function(e){e.preventDefault(),this.loveComment(e,$(e.target))},heartPenInGrid:function(e,t){var n=$("#loves_"+t.attr("data-id"));if(this._userNeedsToLogin(n))this.loginBeforeHearting(n);else if(this._penNOTOwned(n)){var r=n.attr("data-id"),i=this.getNextLoveType(n);this.updatePenHeartInGrid(n,i),this.sendLove(r,i)}},_userNeedsToLogin:function(e){return!e.data("logged-in")},_penNOTOwned:function(e){return!e.data("pen-owned")},loginBeforeHearting:function(e){var t=e.attr("data-id");$.cookie("love_cookie",t),window.location="/login?type=love"},updatePenHeartInGrid:function(e,t){e.removeClass("loved-1 loved-2 loved-3"),e.addClass(t);var n=e.find("span.count"),r=this.getLoveCountValue(t);n.html(this.getLoveCount(n,r))},loveComment:function(e,t){var n=t.data("comment-id"),r=t.data("owner-user-id");this.user.id!==r&&(this.loveCommentVisually(n),this.loveCommentOnServer(n))},loveCommentVisually:function(e){this.isCommentLoved(e)?($("#comment-heart-link-"+e).removeClass("love"),$("#comment-heart-"+e).css("color","#CCC"),$("#comment-heart-count-"+e).html(this.getCommentCount(e,-1))):($("#comment-heart-link-"+e).addClass("love"),$("#comment-heart-"+e).css("color","red"),$("#comment-heart-count-"+e).html(this.getCommentCount(e,1)))},getCommentCount:function(e,t){var n=$("#comment-heart-count-"+e).html(),r=n*1+t;return r>0?r:""},loveCommentOnServer:function(e){var t={slug_hash:CP.pen.slug_hash,comment_id:e,action:"love",love_value:this.isCommentLoved(e)?"love":""};this.post("/comment/love",t)},isCommentLoved:function(e){return $("#comment-heart-link-"+e).hasClass("love")},heartPenInEditor:function(){var e=$("#heart-this"),t=this.getNextLoveType(e);this.optimisticHeartInEditor(e,t),this.sendLove(CP.pen.id,t),this.publishHeartEvent()},optimisticHeartInEditor:function(e,t){e.removeClass("loved loved-1 loved-2 loved-3"),e.addClass(t),t&&e.addClass("loved")},getNextLoveType:function(e){return e.hasClass("loved-1")?"loved-2":e.hasClass("loved-2")?"loved-3":e.hasClass("loved-3")?"":"loved-1"},sendLove:function(e,t){var n={pen_id:e,loved_type:t};this.post("/pen/love",n)},getLoveCount:function(e,t){var n=e.html()*1,r=isNaN(n)?0:n;return r+=t,r>0?r:""},getLoveCountValue:function(e){return e==="loved-1"?1:e==="loved-2"||e==="loved-3"?0:-1},isLoved:function(e){return e.hasClass("loved")||e.hasClass("loved-1")||e.hasClass("loved-2")||e.hasClass("loved-3")},publishHeartEvent:function(){typeof Hub!="undefined"&&Hub.pub("pen-hearted")}};Love.init(),"use strict";var URLBuilder={getHostURL:function(e){var t=document.location,n=t.protocol,r=t.hostname,i=e?"s.":"",s=t.port?":"+t.port:"",o="<%= protocol %>//<%= subdomain %><%= host %><%= port %>";return _.template(o,{protocol:n,subdomain:i,host:r,port:s})},getProtocolLessHostURL:function(e){return this.getHostURL(e).replace(/(http:|https:)/,"")},getViewURL:function(e,t,n,r){return this.getViewURLSimple(e,t.base_url,n.getActiveSlugHash(),r)},getViewURLSimple:function(e,t,n,r){var i=URLBuilder.getHostURL(r);return i+=t+"/",i+=e+"/",i+=n+"/",i},SHORT_HOST:"http://cdpn.io",getShortViewURL:function(e,t){return e?[this.SHORT_HOST,e,t.getActiveSlugHash()].join("/"):[this.SHORT_HOST,t.getActiveSlugHash()].join("/")}};"use strict";var Collections=Class.extend({init:function(){_.extend(this,AJAXUtil),this._bindToDOM()},_bindToDOM:function(){$("#collection-choice")._on("change",this.handleCollectionChoice,this)},handleCollectionChoice:function(e,t){var n=t.find("option:selected").val();n==="__add__"?this.addNewCollection():n!=="Collections"&&this.addThisPenToSelectedCollection(n),this.resetDefaultChoice()},resetDefaultChoice:function(){$("#collection-choice").val("Collections")},addNewCollection:function(){var e="/collection/add_new_collection_modal",t="modal-neutral";$.showModal(e,t,$.proxy(this.doneShowNewCollectionsModal,this))},doneShowNewCollectionsModal:function(){$("#name").focus(),$("#add-new-collection-form")._on("submit",this.saveNewCollectionsModal,this)},saveNewCollectionsModal:function(){var e={name:$("#name").val(),description:$("#description").val(),pen_slug_hash:CP.pen.slug_hash};this.post("/collection/save",e,this.doneSaveNewCollection)},doneSaveNewCollection:function(e){var t={name:e.name,url:"/collection/"+e.slug_hash},n=_.template(Copy.collectionSavedPenAdded,t);$.showMessage(n,"slow"),this.addNewCollectionToSelect(e)},addNewCollectionToSelect:function(e){$("<option value='"+e.id+"'>"+e.name+"</option>").appendTo("#collection-options")},addThisPenToSelectedCollection:function(e){if(e){var t={collection_id:e,slug_hash:CP.pen.slug_hash};$.hideModal(),this.post("/collection/add",t,this.doneAddToCollection)}},doneAddToCollection:function(e){var t={name:e.name,url:"/collection/"+e.slug_hash},n=_.template(Copy.penAddToCollection,t);$.showMessage(n,"slow")}});"use strict";var Upsell=Class.extend({init:function(){this._bindToDOM()},_bindToDOM:function(){$(".upsell")._on("click",this.showDialog)},showDialog:function(e,t){$.showModal(t.data("url"),"modal-pro")},showDialogFromURL:function(e){$.showModal(e,"modal-pro")}});"use strict";var CodeEditorAnalyze=Class.extend({clearingShortcut:!1,init:function(){this.bindUIActions()},bindUIActions:function(){$("#analyze-html")._on("click",this.analyzeHTML,this),$("#analyze-css")._on("click",this.analyzeCSS,this),$("#analyze-js")._on("click",this.analyzeJS,this),$(document).on("click","#clear-html-errors",$.proxy(this.clearHTMLErrors,this)).on("click","#clear-css-errors",$.proxy(this.clearCSSErrors,this)).on("click","#clear-js-errors",$.proxy(this.clearJSErrors,this))},enableClearingShortcut:function(){Keytrap.bind("comctrl+shift+8",function(){Analyze.clearAllHTMLLintErrors(),Analyze.clearAllCSSLintErrors(),Analyze.clearAllJSHintErrors()},!0),this.clearingShortcut=!0},analyzeHTML:function(){this._simulateEscKey(),Loader.run("analyze-html",function(){Analyze.html(),CodeEditorAnalyze.clearingShortcut===!1&&CodeEditorAnalyze.enableClearingShortcut()})},analyzeCSS:function(){this._simulateEscKey(),Loader.run("analyze-css",function(){Analyze.css(),CodeEditorAnalyze.clearingShortcut===!1&&CodeEditorAnalyze.enableClearingShortcut()})},analyzeJS:function(){this._simulateEscKey(),Loader.run("analyze-js",function(){Analyze.js(),CodeEditorAnalyze.clearingShortcut===!1&&CodeEditorAnalyze.enableClearingShortcut()})},clearHTMLErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("html"),this._simulateEscKey()},clearCSSErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("css"),this._simulateEscKey()},clearJSErrors:function(e){e.preventDefault(),Analyze.clearAllErrors("js"),this._simulateEscKey()},_simulateEscKey:function(){Hub.pub("key",{key:"esc"})}});"use strict";var BaseEditorCursorMixin={_setEditorSelection:function(e){Hub.pub("editor-lose-focus",{}),this._onEditorGainFocus(),this._setEditorCursorOrSelection(e)},_setEditorCursorOrSelection:function(e){var t=e.start,n=e.end;if(t.ch!==n.ch||t.line!==n.line)this.editor.doc.setSelection(e.start,e.end);else{var r={line:t.line,ch:t.ch};this.editor.setCursor(r)}},_onEditorGainFocus:function(){$("#box-"+this.type).addClass("student"),this.editor.pseudoFocus()},_onEditorLoseFocus:function(){$("#box-"+this.type).removeClass("student"),this.editor.pseudoLostFocus()},_throttledHandleCollabCursorActivity:!1,_THROTTLE:200,_onCursorActivity:function(e){if(this.pageType==="professor")this._handleProfessorOnCursorActivity(e);else if(this.pageType==="collab"){if(!this._throttledHandleCollabCursorActivity){var t=this;this._throttledHandleCollabCursorActivity=_.throttle(function(e){t._handleCollabOnCursorActivity(e)},this._THROTTLE,{leading:!0,trailing:!1})}this._throttledHandleCollabCursorActivity(e)}},_handleProfessorOnCursorActivity:function(e){var t=this._getOnCursorActivityData(e);CP.ui.textSelection[this.type]=t.ui.textSelection[this.type],Hub.pub("ui-change",t)},_getOnCursorActivityData:function(e){var t={ui:{textSelection:{}}};return t.ui.textSelection[this.type]=this._getCursorsHash(e),t},_handleCollabOnCursorActivity:function(e){this._updateCursorsMap(e)},_cursors:{},_clientID:{},_prevOtherCursors:{},_onSyncOtherCursor:function(e,t){this._clientID=t.clientID,this._cursors=t.cursors,this._initClientCursorState()},_initClientCursorState:function(){this._cursors.get(this._clientID)||this._cursors.set(this._clientID,{}),this._updateCursorsMap(this.editor)},_CLEAR_UNUSED_CURSOR_TIMEOUT:1e4,showOtherCursor:function(e,t){this._cleanUpPrevCursors(e);var n=t[this.type],r=this._getOtherClientColor(e),i=this._setSimpleCurosr(r,e,n);this._prevOtherCursors[e]=i,setTimeout(function(){i.clear()},this._CLEAR_UNUSED_CURSOR_TIMEOUT)},_cleanUpPrevCursors:function(e){this._prevOtherCursors[e]&&this._prevOtherCursors[e].clear()},_otherClientColors:{},_colors:["#1abc9c","#e67e22","#3498db","#f39c12","#9b59b6","#f1c40f"],_getOtherClientColor:function(e){return this._otherClientColors[e]||(this._otherClientColors[e]=this._colors.pop()),this._otherClientColors[e]},_setSimpleCurosr:function(e,t,n){var r=this._buildPseudoCursorEl(e,t,n);return this.editor.addWidget(n.start,r,!1),{clear:function(){var e=r.parentNode;e&&e.removeChild(r)}}},_buildPseudoCursorEl:function(e,t,n){var r=this.editor.charCoords(n.start),i=document.createElement("pre");return i.className="other-client",i.style.borderLeftWidth="2px",i.style.borderLeftStyle="solid",i.innerHTML="&nbsp;",i.style.borderLeftColor=e,i.style.height=(r.bottom-r.top)*.9+"px",i.style.marginTop=r.top-r.bottom+"px",i.style.zIndex=0,i},_updateCursorsMap:function(e){var t={};t[this.type]=this._getCursorsHash(e),this._shouldUpdateCursors(t[this.type])&&this._cursors.set(this._clientID,t)},_shouldUpdateCursors:function(e){return e.start.line===0&&e.start.ch===0&&e.end.line===0&&e.start.ch===0?!1:!0},_getCursorsHash:function(e){return{start:e.doc.getCursor(!0),end:e.doc.getCursor(!1)}}},DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;diff_match_patch.Diff,diff_match_patch.prototype.diff_main=function(e,t,n,r){typeof r=="undefined"&&(this.Diff_Timeout<=0?r=Number.MAX_VALUE:r=(new Date).getTime()+this.Diff_Timeout*1e3);var i=r;if(e==null||t==null)throw new Error("Null input. (diff_main)");if(e==t)return e?[[DIFF_EQUAL,e]]:[];typeof n=="undefined"&&(n=!0);var s=n,o=this.diff_commonPrefix(e,t),u=e.substring(0,o);e=e.substring(o),t=t.substring(o),o=this.diff_commonSuffix(e,t);var a=e.substring(e.length-o);e=e.substring(0,e.length-o),t=t.substring(0,t.length-o);var f=this.diff_compute_(e,t,s,i);return u&&f.unshift([DIFF_EQUAL,u]),a&&f.push([DIFF_EQUAL,a]),this.diff_cleanupMerge(f),f},diff_match_patch.prototype.diff_compute_=function(e,t,n,r){var i;if(!e)return[[DIFF_INSERT,t]];if(!t)return[[DIFF_DELETE,e]];var s=e.length>t.length?e:t,o=e.length>t.length?t:e,u=s.indexOf(o);if(u!=-1)return i=[[DIFF_INSERT,s.substring(0,u)],[DIFF_EQUAL,o],[DIFF_INSERT,s.substring(u+o.length)]],e.length>t.length&&(i[0][0]=i[2][0]=DIFF_DELETE),i;if(o.length==1)return[[DIFF_DELETE,e],[DIFF_INSERT,t]];var a=this.diff_halfMatch_(e,t);if(a){var f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=this.diff_main(f,c,n,r),v=this.diff_main(l,h,n,r);return d.concat([[DIFF_EQUAL,p]],v)}return n&&e.length>100&&t.length>100?this.diff_lineMode_(e,t,r):this.diff_bisect_(e,t,r)},diff_match_patch.prototype.diff_lineMode_=function(e,t,n){var r=this.diff_linesToChars_(e,t);e=r.chars1,t=r.chars2;var i=r.lineArray,s=this.diff_main(e,t,!1,n);this.diff_charsToLines_(s,i),this.diff_cleanupSemantic(s),s.push([DIFF_EQUAL,""]);var o=0,u=0,a=0,f="",l="";while(o<s.length){switch(s[o][0]){case DIFF_INSERT:a++,l+=s[o][1];break;case DIFF_DELETE:u++,f+=s[o][1];break;case DIFF_EQUAL:if(u>=1&&a>=1){s.splice(o-u-a,u+a),o=o-u-a;var r=this.diff_main(f,l,!1,n);for(var c=r.length-1;c>=0;c--)s.splice(o,0,r[c]);o+=r.length}a=0,u=0,f="",l=""}o++}return s.pop(),s},diff_match_patch.prototype.diff_bisect_=function(e,t,n){var r=e.length,i=t.length,s=Math.ceil((r+i)/2),o=s,u=2*s,a=new Array(u),f=new Array(u);for(var l=0;l<u;l++)a[l]=-1,f[l]=-1;a[o+1]=0,f[o+1]=0;var c=r-i,h=c%2!=0,p=0,d=0,v=0,m=0;for(var g=0;g<s;g++){if((new Date).getTime()>n)break;for(var y=-g+p;y<=g-d;y+=2){var b=o+y,w;y==-g||y!=g&&a[b-1]<a[b+1]?w=a[b+1]:w=a[b-1]+1;var E=w-y;while(w<r&&E<i&&e.charAt(w)==t.charAt(E))w++,E++;a[b]=w;if(w>r)d+=2;else if(E>i)p+=2;else if(h){var S=o+c-y;if(S>=0&&S<u&&f[S]!=-1){var x=r-f[S];if(w>=x)return this.diff_bisectSplit_(e,t,w,E,n)}}}for(var T=-g+v;T<=g-m;T+=2){var S=o+T,x;T==-g||T!=g&&f[S-1]<f[S+1]?x=f[S+1]:x=f[S-1]+1;var N=x-T;while(x<r&&N<i&&e.charAt(r-x-1)==t.charAt(i-N-1))x++,N++;f[S]=x;if(x>r)m+=2;else if(N>i)v+=2;else if(!h){var b=o+c-T;if(b>=0&&b<u&&a[b]!=-1){var w=a[b],E=o+w-b;x=r-x;if(w>=x)return this.diff_bisectSplit_(e,t,w,E,n)}}}}return[[DIFF_DELETE,e],[DIFF_INSERT,t]]},diff_match_patch.prototype.diff_bisectSplit_=function(e,t,n,r,i){var s=e.substring(0,n),o=t.substring(0,r),u=e.substring(n),a=t.substring(r),f=this.diff_main(s,o,!1,i),l=this.diff_main(u,a,!1,i);return f.concat(l)},diff_match_patch.prototype.diff_linesToChars_=function(e,t){function i(e){var t="",i=0,s=-1,o=n.length;while(s<e.length-1){s=e.indexOf("\n",i),s==-1&&(s=e.length-1);var u=e.substring(i,s+1);i=s+1,(r.hasOwnProperty?r.hasOwnProperty(u):r[u]!==undefined)?t+=String.fromCharCode(r[u]):(t+=String.fromCharCode(o),r[u]=o,n[o++]=u)}return t}var n=[],r={};n[0]="";var s=i(e),o=i(t);return{chars1:s,chars2:o,lineArray:n}},diff_match_patch.prototype.diff_charsToLines_=function(e,t){for(var n=0;n<e.length;n++){var r=e[n][1],i=[];for(var s=0;s<r.length;s++)i[s]=t[r.charCodeAt(s)];e[n][1]=i.join("")}},diff_match_patch.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;var n=0,r=Math.min(e.length,t.length),i=r,s=0;while(n<i)e.substring(s,i)==t.substring(s,i)?(n=i,s=n):r=i,i=Math.floor((r-n)/2+n);return i},diff_match_patch.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;var n=0,r=Math.min(e.length,t.length),i=r,s=0;while(n<i)e.substring(e.length-i,e.length-s)==t.substring(t.length-i,t.length-s)?(n=i,s=n):r=i,i=Math.floor((r-n)/2+n);return i},diff_match_patch.prototype.diff_commonOverlap_=function(e,t){var n=e.length,r=t.length;if(n==0||r==0)return 0;n>r?e=e.substring(n-r):n<r&&(t=t.substring(0,n));var i=Math.min(n,r);if(e==t)return i;var s=0,o=1;for(;;){var u=e.substring(i-o),a=t.indexOf(u);if(a==-1)return s;o+=a;if(a==0||e.substring(i-o)==t.substring(0,o))s=o,o++}},diff_match_patch.prototype.diff_halfMatch_=function(e,t){function s(e,t,n){var r=e.substring(n,n+Math.floor(e.length/4)),s=-1,o="",u,a,f,l;while((s=t.indexOf(r,s+1))!=-1){var c=i.diff_commonPrefix(e.substring(n),t.substring(s)),h=i.diff_commonSuffix(e.substring(0,n),t.substring(0,s));o.length<h+c&&(o=t.substring(s-h,s)+t.substring(s,s+c),u=e.substring(0,n-h),a=e.substring(n+c),f=t.substring(0,s-h),l=t.substring(s+c))}return o.length*2>=e.length?[u,a,f,l,o]:null}if(this.Diff_Timeout<=0)return null;var n=e.length>t.length?e:t,r=e.length>t.length?t:e;if(n.length<4||r.length*2<n.length)return null;var i=this,o=s(n,r,Math.ceil(n.length/4)),u=s(n,r,Math.ceil(n.length/2)),a;if(!o&&!u)return null;u?o?a=o[4].length>u[4].length?o:u:a=u:a=o;var f,l,c,h;e.length>t.length?(f=a[0],l=a[1],c=a[2],h=a[3]):(c=a[0],h=a[1],f=a[2],l=a[3]);var p=a[4];return[f,l,c,h,p]},diff_match_patch.prototype.diff_cleanupSemantic=function(e){var t=!1,n=[],r=0,i=null,s=0,o=0,u=0,a=0,f=0;while(s<e.length)e[s][0]==DIFF_EQUAL?(n[r++]=s,o=a,u=f,a=0,f=0,i=e[s][1]):(e[s][0]==DIFF_INSERT?a+=e[s][1].length:f+=e[s][1].length,i&&i.length<=Math.max(o,u)&&i.length<=Math.max(a,f)&&(e.splice(n[r-1],0,[DIFF_DELETE,i]),e[n[r-1]+1][0]=DIFF_INSERT,r--,r--,s=r>0?n[r-1]:-1,o=0,u=0,a=0,f=0,i=null,t=!0)),s++;t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),s=1;while(s<e.length){if(e[s-1][0]==DIFF_DELETE&&e[s][0]==DIFF_INSERT){var l=e[s-1][1],c=e[s][1],h=this.diff_commonOverlap_(l,c),p=this.diff_commonOverlap_(c,l);if(h>=p){if(h>=l.length/2||h>=c.length/2)e.splice(s,0,[DIFF_EQUAL,c.substring(0,h)]),e[s-1][1]=l.substring(0,l.length-h),e[s+1][1]=c.substring(h),s++}else if(p>=l.length/2||p>=c.length/2)e.splice(s,0,[DIFF_EQUAL,l.substring(0,p)]),e[s-1][0]=DIFF_INSERT,e[s-1][1]=c.substring(0,c.length-p),e[s+1][0]=DIFF_DELETE,e[s+1][1]=l.substring(p),s++;s++}s++}},diff_match_patch.prototype.diff_cleanupSemanticLossless=function(e){function t(e,t){if(!e||!t)return 6;var n=e.charAt(e.length-1),r=t.charAt(0),i=n.match(diff_match_patch.nonAlphaNumericRegex_),s=r.match(diff_match_patch.nonAlphaNumericRegex_),o=i&&n.match(diff_match_patch.whitespaceRegex_),u=s&&r.match(diff_match_patch.whitespaceRegex_),a=o&&n.match(diff_match_patch.linebreakRegex_),f=u&&r.match(diff_match_patch.linebreakRegex_),l=a&&e.match(diff_match_patch.blanklineEndRegex_),c=f&&t.match(diff_match_patch.blanklineStartRegex_);return l||c?5:a||f?4:i&&!o&&u?3:o||u?2:i||s?1:0}var n=1;while(n<e.length-1){if(e[n-1][0]==DIFF_EQUAL&&e[n+1][0]==DIFF_EQUAL){var r=e[n-1][1],i=e[n][1],s=e[n+1][1],o=this.diff_commonSuffix(r,i);if(o){var u=i.substring(i.length-o);r=r.substring(0,r.length-o),i=u+i.substring(0,i.length-o),s=u+s}var a=r,f=i,l=s,c=t(r,i)+t(i,s);while(i.charAt(0)===s.charAt(0)){r+=i.charAt(0),i=i.substring(1)+s.charAt(0),s=s.substring(1);var h=t(r,i)+t(i,s);h>=c&&(c=h,a=r,f=i,l=s)}e[n-1][1]!=a&&(a?e[n-1][1]=a:(e.splice(n-1,1),n--),e[n][1]=f,l?e[n+1][1]=l:(e.splice(n+1,1),n--))}n++}},diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff_match_patch.whitespaceRegex_=/\s/,diff_match_patch.linebreakRegex_=/[\r\n]/,diff_match_patch.blanklineEndRegex_=/\n\r?\n$/,diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/,diff_match_patch.prototype.diff_cleanupEfficiency=function(e){var t=!1,n=[],r=0,i=null,s=0,o=!1,u=!1,a=!1,f=!1;while(s<e.length)e[s][0]==DIFF_EQUAL?(e[s][1].length<this.Diff_EditCost&&(a||f)?(n[r++]=s,o=a,u=f,i=e[s][1]):(r=0,i=null),a=f=!1):(e[s][0]==DIFF_DELETE?f=!0:a=!0,i&&(o&&u&&a&&f||i.length<this.Diff_EditCost/2&&o+u+a+f==3)&&(e.splice(n[r-1],0,[DIFF_DELETE,i]),e[n[r-1]+1][0]=DIFF_INSERT,r--,i=null,o&&u?(a=f=!0,r=0):(r--,s=r>0?n[r-1]:-1,a=f=!1),t=!0)),s++;t&&this.diff_cleanupMerge(e)},diff_match_patch.prototype.diff_cleanupMerge=function(e){e.push([DIFF_EQUAL,""]);var t=0,n=0,r=0,i="",s="",o;while(t<e.length)switch(e[t][0]){case DIFF_INSERT:r++,s+=e[t][1],t++;break;case DIFF_DELETE:n++,i+=e[t][1],t++;break;case DIFF_EQUAL:n+r>1?(n!==0&&r!==0&&(o=this.diff_commonPrefix(s,i),o!==0&&(t-n-r>0&&e[t-n-r-1][0]==DIFF_EQUAL?e[t-n-r-1][1]+=s.substring(0,o):(e.splice(0,0,[DIFF_EQUAL,s.substring(0,o)]),t++),s=s.substring(o),i=i.substring(o)),o=this.diff_commonSuffix(s,i),o!==0&&(e[t][1]=s.substring(s.length-o)+e[t][1],s=s.substring(0,s.length-o),i=i.substring(0,i.length-o))),n===0?e.splice(t-r,n+r,[DIFF_INSERT,s]):r===0?e.splice(t-n,n+r,[DIFF_DELETE,i]):e.splice(t-n-r,n+r,[DIFF_DELETE,i],[DIFF_INSERT,s]),t=t-n-r+(n?1:0)+(r?1:0)+1):t!==0&&e[t-1][0]==DIFF_EQUAL?(e[t-1][1]+=e[t][1],e.splice(t,1)):t++,r=0,n=0,i="",s=""}e[e.length-1][1]===""&&e.pop();var u=!1;t=1;while(t<e.length-1)e[t-1][0]==DIFF_EQUAL&&e[t+1][0]==DIFF_EQUAL&&(e[t][1].substring(e[t][1].length-e[t-1][1].length)==e[t-1][1]?(e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length),e[t+1][1]=e[t-1][1]+e[t+1][1],e.splice(t-1,1),u=!0):e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]&&(e[t-1][1]+=e[t+1][1],e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1],e.splice(t+1,1),u=!0)),t++;u&&this.diff_cleanupMerge(e)},diff_match_patch.prototype.diff_xIndex=function(e,t){var n=0,r=0,i=0,s=0,o;for(o=0;o<e.length;o++){e[o][0]!==DIFF_INSERT&&(n+=e[o][1].length),e[o][0]!==DIFF_DELETE&&(r+=e[o][1].length);if(n>t)break;i=n,s=r}return e.length!=o&&e[o][0]===DIFF_DELETE?s:s+(t-i)},diff_match_patch.prototype.diff_prettyHtml=function(e){var t=[],n=/&/g,r=/</g,i=/>/g,s=/\n/g;for(var o=0;o<e.length;o++){var u=e[o][0],a=e[o][1],f=a.replace(n,"&amp;").replace(r,"&lt;").replace(i,"&gt;").replace(s,"&para;<br>");switch(u){case DIFF_INSERT:t[o]='<ins style="background:#e6ffe6;">'+f+"</ins>";break;case DIFF_DELETE:t[o]='<del style="background:#ffe6e6;">'+f+"</del>";break;case DIFF_EQUAL:t[o]="<span>"+f+"</span>"}}return t.join("")},diff_match_patch.prototype.diff_text1=function(e){var t=[];for(var n=0;n<e.length;n++)e[n][0]!==DIFF_INSERT&&(t[n]=e[n][1]);return t.join("")},diff_match_patch.prototype.diff_text2=function(e){var t=[];for(var n=0;n<e.length;n++)e[n][0]!==DIFF_DELETE&&(t[n]=e[n][1]);return t.join("")},diff_match_patch.prototype.diff_levenshtein=function(e){var t=0,n=0,r=0;for(var i=0;i<e.length;i++){var s=e[i][0],o=e[i][1];switch(s){case DIFF_INSERT:n+=o.length;break;case DIFF_DELETE:r+=o.length;break;case DIFF_EQUAL:t+=Math.max(n,r),n=0,r=0}}return t+=Math.max(n,r),t},diff_match_patch.prototype.diff_toDelta=function(e){var t=[];for(var n=0;n<e.length;n++)switch(e[n][0]){case DIFF_INSERT:t[n]="+"+encodeURI(e[n][1]);break;case DIFF_DELETE:t[n]="-"+e[n][1].length;break;case DIFF_EQUAL:t[n]="="+e[n][1].length}return t.join("	").replace(/%20/g," ")},diff_match_patch.prototype.diff_fromDelta=function(e,t){var n=[],r=0,i=0,s=t.split(/\t/g);for(var o=0;o<s.length;o++){var u=s[o].substring(1);switch(s[o].charAt(0)){case"+":try{n[r++]=[DIFF_INSERT,decodeURI(u)]}catch(a){throw new Error("Illegal escape in diff_fromDelta: "+u)}break;case"-":case"=":var f=parseInt(u,10);if(isNaN(f)||f<0)throw new Error("Invalid number in diff_fromDelta: "+u);var l=e.substring(i,i+=f);s[o].charAt(0)=="="?n[r++]=[DIFF_EQUAL,l]:n[r++]=[DIFF_DELETE,l];break;default:if(s[o])throw new Error("Invalid diff operation in diff_fromDelta: "+s[o])}}if(i!=e.length)throw new Error("Delta length ("+i+") does not equal source text length ("+e.length+").");return n},diff_match_patch.prototype.match_main=function(e,t,n){if(e==null||t==null||n==null)throw new Error("Null input. (match_main)");return n=Math.max(0,Math.min(n,e.length)),e==t?0:e.length?e.substring(n,n+t.length)==t?n:this.match_bitap_(e,t,n):-1},diff_match_patch.prototype.match_bitap_=function(e,t,n){function s(e,r){var s=e/t.length,o=Math.abs(n-r);return i.Match_Distance?s+o/i.Match_Distance:o?1:s}if(t.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var r=this.match_alphabet_(t),i=this,o=this.Match_Threshold,u=e.indexOf(t,n);u!=-1&&(o=Math.min(s(0,u),o),u=e.lastIndexOf(t,n+t.length),u!=-1&&(o=Math.min(s(0,u),o)));var a=1<<t.length-1;u=-1;var f,l,c=t.length+e.length,h;for(var p=0;p<t.length;p++){f=0,l=c;while(f<l)s(p,n+l)<=o?f=l:c=l,l=Math.floor((c-f)/2+f);c=l;var d=Math.max(1,n-l+1),v=Math.min(n+l,e.length)+t.length,m=Array(v+2);m[v+1]=(1<<p)-1;for(var g=v;g>=d;g--){var y=r[e.charAt(g-1)];p===0?m[g]=(m[g+1]<<1|1)&y:m[g]=(m[g+1]<<1|1)&y|((h[g+1]|h[g])<<1|1)|h[g+1];if(m[g]&a){var b=s(p,g-1);if(b<=o){o=b,u=g-1;if(!(u>n))break;d=Math.max(1,2*n-u)}}}if(s(p+1,n)>o)break;h=m}return u},diff_match_patch.prototype.match_alphabet_=function(e){var t={};for(var n=0;n<e.length;n++)t[e.charAt(n)]=0;for(var n=0;n<e.length;n++)t[e.charAt(n)]|=1<<e.length-n-1;return t},diff_match_patch.prototype.patch_addContext_=function(e,t){if(t.length==0)return;var n=t.substring(e.start2,e.start2+e.length1),r=0;while(t.indexOf(n)!=t.lastIndexOf(n)&&n.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin)r+=this.Patch_Margin,n=t.substring(e.start2-r,e.start2+e.length1+r);r+=this.Patch_Margin;var i=t.substring(e.start2-r,e.start2);i&&e.diffs.unshift([DIFF_EQUAL,i]);var s=t.substring(e.start2+e.length1,e.start2+e.length1+r);s&&e.diffs.push([DIFF_EQUAL,s]),e.start1-=i.length,e.start2-=i.length,e.length1+=i.length+s.length,e.length2+=i.length+s.length},diff_match_patch.prototype.patch_make=function(e,t,n){var r,i;if(typeof e=="string"&&typeof t=="string"&&typeof n=="undefined")r=e,i=this.diff_main(r,t,!0),i.length>2&&(this.diff_cleanupSemantic(i),this.diff_cleanupEfficiency(i));else if(e&&typeof e=="object"&&typeof t=="undefined"&&typeof n=="undefined")i=e,r=this.diff_text1(i);else if(typeof e=="string"&&t&&typeof t=="object"&&typeof n=="undefined")r=e,i=t;else{if(typeof e!="string"||typeof t!="string"||!n||typeof n!="object")throw new Error("Unknown call format to patch_make.");r=e,i=n}if(i.length===0)return[];var s=[],o=new diff_match_patch.patch_obj,u=0,a=0,f=0,l=r,c=r;for(var h=0;h<i.length;h++){var p=i[h][0],d=i[h][1];!u&&p!==DIFF_EQUAL&&(o.start1=a,o.start2=f);switch(p){case DIFF_INSERT:o.diffs[u++]=i[h],o.length2+=d.length,c=c.substring(0,f)+d+c.substring(f);break;case DIFF_DELETE:o.length1+=d.length,o.diffs[u++]=i[h],c=c.substring(0,f)+c.substring(f+d.length);break;case DIFF_EQUAL:d.length<=2*this.Patch_Margin&&u&&i.length!=h+1?(o.diffs[u++]=i[h],o.length1+=d.length,o.length2+=d.length):d.length>=2*this.Patch_Margin&&u&&(this.patch_addContext_(o,l),s.push(o),o=new diff_match_patch.patch_obj,u=0,l=c,a=f)}p!==DIFF_INSERT&&(a+=d.length),p!==DIFF_DELETE&&(f+=d.length)}return u&&(this.patch_addContext_(o,l),s.push(o)),s},diff_match_patch.prototype.patch_deepCopy=function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n],i=new diff_match_patch.patch_obj;i.diffs=[];for(var s=0;s<r.diffs.length;s++)i.diffs[s]=r.diffs[s].slice();i.start1=r.start1,i.start2=r.start2,i.length1=r.length1,i.length2=r.length2,t[n]=i}return t},diff_match_patch.prototype.patch_apply=function(e,t){if(e.length==0)return[t,[]];e=this.patch_deepCopy(e);var n=this.patch_addPadding(e);t=n+t+n,this.patch_splitMax(e);var r=0,i=[];for(var s=0;s<e.length;s++){var o=e[s].start2+r,u=this.diff_text1(e[s].diffs),a,f=-1;if(u.length>this.Match_MaxBits){a=this.match_main(t,u.substring(0,this.Match_MaxBits),o);if(a!=-1){f=this.match_main(t,u.substring(u.length-this.Match_MaxBits),o+u.length-this.Match_MaxBits);if(f==-1||a>=f)a=-1}}else a=this.match_main(t,u,o);if(a==-1)i[s]=!1,r-=e[s].length2-e[s].length1;else{i[s]=!0,r=a-o;var l;f==-1?l=t.substring(a,a+u.length):l=t.substring(a,f+this.Match_MaxBits);if(u==l)t=t.substring(0,a)+this.diff_text2(e[s].diffs)+t.substring(a+u.length);else{var c=this.diff_main(u,l,!1);if(u.length>this.Match_MaxBits&&this.diff_levenshtein(c)/u.length>this.Patch_DeleteThreshold)i[s]=!1;else{this.diff_cleanupSemanticLossless(c);var h=0,p;for(var d=0;d<e[s].diffs.length;d++){var v=e[s].diffs[d];v[0]!==DIFF_EQUAL&&(p=this.diff_xIndex(c,h)),v[0]===DIFF_INSERT?t=t.substring(0,a+p)+v[1]+t.substring(a+p):v[0]===DIFF_DELETE&&(t=t.substring(0,a+p)+t.substring(a+this.diff_xIndex(c,h+v[1].length))),v[0]!==DIFF_DELETE&&(h+=v[1].length)}}}}}return t=t.substring(n.length,t.length-n.length),[t,i]},diff_match_patch.prototype.patch_addPadding=function(e){var t=this.Patch_Margin,n="";for(var r=1;r<=t;r++)n+=String.fromCharCode(r);for(var r=0;r<e.length;r++)e[r].start1+=t,e[r].start2+=t;var i=e[0],s=i.diffs;if(s.length==0||s[0][0]!=DIFF_EQUAL)s.unshift([DIFF_EQUAL,n]),i.start1-=t,i.start2-=t,i.length1+=t,i.length2+=t;else if(t>s[0][1].length){var o=t-s[0][1].length;s[0][1]=n.substring(s[0][1].length)+s[0][1],i.start1-=o,i.start2-=o,i.length1+=o,i.length2+=o}i=e[e.length-1],s=i.diffs;if(s.length==0||s[s.length-1][0]!=DIFF_EQUAL)s.push([DIFF_EQUAL,n]),i.length1+=t,i.length2+=t;else if(t>s[s.length-1][1].length){var o=t-s[s.length-1][1].length;s[s.length-1][1]+=n.substring(0,o),i.length1+=o,i.length2+=o}return n},diff_match_patch.prototype.patch_splitMax=function(e){var t=this.Match_MaxBits;for(var n=0;n<e.length;n++){if(e[n].length1<=t)continue;var r=e[n];e.splice(n--,1);var i=r.start1,s=r.start2,o="";while(r.diffs.length!==0){var u=new diff_match_patch.patch_obj,a=!0;u.start1=i-o.length,u.start2=s-o.length,o!==""&&(u.length1=u.length2=o.length,u.diffs.push([DIFF_EQUAL,o]));while(r.diffs.length!==0&&u.length1<t-this.Patch_Margin){var f=r.diffs[0][0],l=r.diffs[0][1];f===DIFF_INSERT?(u.length2+=l.length,s+=l.length,u.diffs.push(r.diffs.shift()),a=!1):f===DIFF_DELETE&&u.diffs.length==1&&u.diffs[0][0]==DIFF_EQUAL&&l.length>2*t?(u.length1+=l.length,i+=l.length,a=!1,u.diffs.push([f,l]),r.diffs.shift()):(l=l.substring(0,t-u.length1-this.Patch_Margin),u.length1+=l.length,i+=l.length,f===DIFF_EQUAL?(u.length2+=l.length,s+=l.length):a=!1,u.diffs.push([f,l]),l==r.diffs[0][1]?r.diffs.shift():r.diffs[0][1]=r.diffs[0][1].substring(l.length))}o=this.diff_text2(u.diffs),o=o.substring(o.length-this.Patch_Margin);var c=this.diff_text1(r.diffs).substring(0,this.Patch_Margin);c!==""&&(u.length1+=c.length,u.length2+=c.length,u.diffs.length!==0&&u.diffs[u.diffs.length-1][0]===DIFF_EQUAL?u.diffs[u.diffs.length-1][1]+=c:u.diffs.push([DIFF_EQUAL,c])),a||e.splice(++n,0,u)}}},diff_match_patch.prototype.patch_toText=function(e){var t=[];for(var n=0;n<e.length;n++)t[n]=e[n];return t.join("")},diff_match_patch.prototype.patch_fromText=function(e){var t=[];if(!e)return t;var n=e.split("\n"),r=0,i=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;while(r<n.length){var s=n[r].match(i);if(!s)throw new Error("Invalid patch string: "+n[r]);var o=new diff_match_patch.patch_obj;t.push(o),o.start1=parseInt(s[1],10),s[2]===""?(o.start1--,o.length1=1):s[2]=="0"?o.length1=0:(o.start1--,o.length1=parseInt(s[2],10)),o.start2=parseInt(s[3],10),s[4]===""?(o.start2--,o.length2=1):s[4]=="0"?o.length2=0:(o.start2--,o.length2=parseInt(s[4],10)),r++;while(r<n.length){var u=n[r].charAt(0);try{var a=decodeURI(n[r].substring(1))}catch(f){throw new Error("Illegal escape in patch_fromText: "+a)}if(u=="-")o.diffs.push([DIFF_DELETE,a]);else if(u=="+")o.diffs.push([DIFF_INSERT,a]);else if(u==" ")o.diffs.push([DIFF_EQUAL,a]);else{if(u=="@")break;if(u!=="")throw new Error('Invalid patch mode "'+u+'" in: '+a)}r++}}return t},diff_match_patch.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},diff_match_patch.patch_obj.prototype.toString=function(){var e,t;this.length1===0?e=this.start1+",0":this.length1==1?e=this.start1+1:e=this.start1+1+","+this.length1,this.length2===0?t=this.start2+",0":this.length2==1?t=this.start2+1:t=this.start2+1+","+this.length2;var n=["@@ -"+e+" +"+t+" @@\n"],r;for(var i=0;i<this.diffs.length;i++){switch(this.diffs[i][0]){case DIFF_INSERT:r="+";break;case DIFF_DELETE:r="-";break;case DIFF_EQUAL:r=" "}n[i+1]=r+encodeURI(this.diffs[i][1])+"\n"}return n.join("").replace(/%20/g," ")},this.diff_match_patch=diff_match_patch,this.DIFF_DELETE=DIFF_DELETE,this.DIFF_INSERT=DIFF_INSERT,this.DIFF_EQUAL=DIFF_EQUAL,"use strict";var BaseEditor=Class.extend({editor:"",_viewingSource:!1,_enabled:!0,type:"",value:"",init:function(e,t){this.type=e,this.value=t,this.pageType=__pageType,this.mobile=__mobile,this.dmp=new diff_match_patch,this._onEditorChangeFunc=$.proxy(this._onEditorChange,this),_.extend(this,BaseEditorSetValueMixin),_.extend(this,BaseEditorScrollingMixin),_.extend(this,BaseEditorViewSourceMixin),_.extend(this,BaseEditorCursorMixin),this._baseBindToHub(),this._loadTabSnippets(this.type),this._buildEditor()},_baseBindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("page-loading-done",$.proxy(this._onPageLoadingDone,this)),Hub.sub("editor-refresh",$.proxy(this.refresh,this)),Hub.sub("editor-lose-focus",$.proxy(this._onEditorLoseFocus,this)),Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("sync-other-cursor",$.proxy(this._onSyncOtherCursor,this)),Hub.sub("server-pen-change",$.proxy(this._onServerPenChange,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_onKey:function(e,t){t.key==="esc"&&(this.editor.execCommand("clearSearch"),this.runRefresh(200))},_onServerPenChange:function(e,t){this.pageType==="professor"&&
this.type in t.pen&&this.setEditorValueInProfessor(t.pen[this.type])},_onServerUIChange:function(e,t){var n="";if("textSelection"in t.ui)for(n in t.ui.textSelection)n===this.type&&this._setEditorSelection(t.ui.textSelection[n]);if("scrollTopLine"in t.ui)for(n in t.ui.scrollTopLine)n===this.type&&this._scrollToLine(t.ui.scrollTopLine[n])},_onPageLoadingDone:function(){this._indentWrappedLines(),this.runRefresh(200)},_indentWrappedLines:function(){var e=this.editor.defaultCharWidth(),t=2;this.editor.on("renderLine",function(n,r,i){var s=n.getOption("tabSize"),o=CodeMirror.countColumn(r.text,null,s)*e;i.style.textIndent="-"+o+"px",i.style.paddingLeft=t+o+"px"})},_buildEditor:function(){this.editor=this._buildCMEditor(this._getEditorConfig()),this._setMode(),this._bindToHub(),this.editor.setOption("showCursorWhenSelecting",!0),this.editor.setOption("autoCloseBrackets",!0),this._conditionallyLoadCMKeyBindings(),this.bindToOnChange(),this._bindToRealtimeEditorEvents()},_getEditorConfig:function(){var e=this._getDefaultEditorConfig(this.value);return _.extend(e,this._getEditorTypeSpecificConfig()),e},_getDefaultEditorConfig:function(e){return{lineNumbers:!0,value:e,tabSize:2,indentWithTabs:!1,matchBrackets:!0,lineWrapping:!0}},_buildCMEditor:function(e){var t=this._getTextAreaElementToReplaceWithCodeMirror();return CodeMirror(function(e){t.parentNode.replaceChild(e,t)},e)},_getTextAreaElementToReplaceWithCodeMirror:function(){var e="#"+this.type;return $(e)[0]},_conditionallyLoadCMKeyBindings:function(){_.isUndefined(window.CMKeyBindings)||this.editor.on("keydown",$.proxy(CMKeyBindings.handleKeydown,CMKeyBindings))},_bindToRealtimeEditorEvents:function(){this.pageType==="professor"?(this.editor.on("cursorActivity",$.proxy(this._onCursorActivity,this)),this.editor.on("scroll",$.proxy(this._onScroll,this))):this.pageType==="collab"&&this.editor.on("cursorActivity",$.proxy(this._onCursorActivity,this))},_disableUI:function(){this._enabled=!1,this.editor.setOption("readOnly",!0)},_enableUI:function(){this._enabled=!0,this.editor.setOption("readOnly",!1)},_preProcessorChanged:function(e){this._turnOffReadOnlyView(),this._changeMode(e),this._loadTabSnippets(this.type)},_turnOffReadOnlyView:function(){this._viewingSource&&this.showOriginalCode()},LOAD_TAB_SNIPPETS_WAIT_TIME:500,_loadTabSnippets:function(e){_.isUndefined(window.TabSnippets)||setTimeout(function(){TabSnippets.loadSnippet(e)},this.LOAD_TAB_SNIPPETS_WAIT_TIME)},unbindOnChange:function(){this.editor.off("change",this._onEditorChangeFunc)},bindToOnChange:function(){this.editor.on("change",this._onEditorChangeFunc)},_onEditorChange:function(e){var t=this.editor.getOption("readOnly");if(t===!1){var n={origin:"client",pen:{}};n.pen[this.type]=e.getValue(),CP.pen.setPenValue(n)}},getValue:function(){return this.editor.getValue()},getMode:function(){return this.type},hasFocus:function(){return this.editor.hasFocus()},refresh:function(e,t){this.runRefresh(t.delay)},runRefresh:function(e){e>0?setTimeout($.proxy(function(){this.runRefresh()},this),e):this.editor.refresh()}});"use strict";var BaseEditorScrollingMixin={SHOW_PREVIOUS_LINES:1,$scrollableElement:!1,getScrollTopLine:function(){return Math.floor(this._getScrollTop()/this._getLineHeight())},_getScrollTop:function(){return this._getScrollableElement().scrollTop()},_setScrollTop:function(e){this._getScrollableElement().scrollTop(e)},_scrollToLine:function(e){var t;e>this.SHOW_PREVIOUS_LINES?t=e-this.SHOW_PREVIOUS_LINES:t=e;var n=Math.floor(this._getLineHeight()*t);this._setScrollTop(n)},_getLineHeight:function(){var e=this._getScrollableElement()[0].scrollHeight;return e/this.editor.lineCount()},_getScrollableElement:function(){if(!this.$scrollableElement){this.$scrollableElement=$("#box-"+this.type+" .CodeMirror-scroll");if(this.$scrollableElement.length<0)throw new Error("Unable to sync scroll. Please contact support@codepen.io.")}return this.$scrollableElement},_onScroll:function(){var e={ui:{scrollTopLine:{}}};e.ui.scrollTopLine[this.type]=this.getScrollTopLine(),Hub.pub("ui-change",e)}};"use strict";var BaseEditorSetValueMixin={setValue:function(e){this.editor.setValue(e)},SCROLL_PAST_LINES:5,setEditorValueInProfessor:function(e){var t=this.editor.getCursor();this.editor.setValue(e),this.editor.setCursor(t),t.line+this.SCROLL_PAST_LINES<this.editor.lineCount()&&(t.line+=this.SCROLL_PAST_LINES,this.editor.scrollIntoView(t))},setEditorValueInCollab:function(e){var t=this.editor.lineCount(),n=this.editor.getCursor(),r=this.editor.getLine(n.line)||"",i=this._getScrollTop(),s=r.substring(0,n.ch),o=n.ch;this._setEditorValue(e),n.line=this._calculateCursorLineNumber(r,n.line,t,o),n.ch=this._calculateCursorChPosition(n.line,n.ch,s,r),this.editor.setCursor(n.line,n.ch),this._setScrollTop(i),this._setPenValueInCollab(e)},_setPenValueInCollab:function(e){var t={origin:"server",pen:{}};t.pen[this.type]=e,CP.pen.setPenValue(t)},_setEditorValue:function(e){this.unbindOnChange(),this.editor.setValue(e),this.bindToOnChange()},_calculateCursorLineNumber:function(e,t,n,r){e=e||"";var i=this.editor.lineCount(),s=Math.abs(n-i);if(s===0)return t;var o="",u=0,a=0;for(var f=0;f<s+1;f++)if(f===0){o=this.editor.getLine(t)||"";if(this._calcLineMatchScore(o,e,r)>-1)return t}else{if(t-f>-1){u=t-f,o=this.editor.getLine(u)||"";var l=this._calcLineMatchScore(o,e,r);if(l>-1)return u}if(t+f<i){a=t+f,o=this.editor.getLine(a)||"";var c=this._calcLineMatchScore(o,e,r);if(c>-1)return a}}return t},MAX_OLD_LINE_LENGTH:30,_calcLineMatchScore:function(e,t,n){return n=n>0?n:1,this.dmp.Match_Distance=e.length,t=t.substring(0,this.MAX_OLD_LINE_LENGTH),this.dmp.Match_Threshold=.4,this.dmp.match_main(e,t,n)},_calculateCursorChPosition:function(e,t,n,r){var i=this.editor.getLine(e)||"",s=i.substring(0,t);return n!==s&&(t+=i.length-r.length,t=t<0?0:t),t}};"use strict";var BaseEditorViewSourceMixin={showSource:function(){this.unbindOnChange(),this._makeEditorReadOnly(),this._showSource()},_showSource:function(){CP.penErrorHandler.clearPreprocWidgets(this.type),this._setEditorValue(CP.penRenderer.getPostProcessed(this.type))},_makeEditorReadOnly:function(){$("#box-"+this.type).addClass("view-compiled"),$("#viewsource-"+this.type).attr("title",Copy.returnToSource),this.editor.setOption("readOnly",!0)},showOriginalCode:function(){this._showOriginalCode(),this._makeEditable(),this.bindToOnChange()},_showOriginalCode:function(){this._setEditorValue(CP.pen[this.type])},_makeEditable:function(){$("#box-"+this.type).removeClass("view-compiled"),$("#viewsource-"+this.type).attr("title",Copy.viewSource),this._enabled&&this.editor.setOption("readOnly",!1)}};"use strict";var CSSEditor=BaseEditor.extend({MODES:{none:"text/css",scss:"text/x-scss",stylus:"text/css",less:"text/x-less",sass:"text/x-sass"},_setMode:function(){this._changeMode(CP.pen.css_pre_processor)},getMode:function(){return this.MODES[CP.pen.css_pre_processor]},_changeMode:function(e){var t=this.MODES[e];Loader.run("mode_"+t,$.proxy(function(){this.editor.setOption("mode",t)},this))},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this)),Hub.sub("page-loading-done",$.proxy(this._onPageLoadingDone,this))},_onPenChange:function(e,t){"css_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.css_pre_processor)},_onPageLoadingDone:function(){this.mobile&&setTimeout($.proxy(function(){this.editor.focus()},this),400)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode()}}});"use strict";var HTMLEditor=BaseEditor.extend({MODES:{none:"xml",haml:"haml",slim:"xml",markdown:"markdown",jade:"jade"},_setMode:function(){this._changeMode(CP.pen.html_pre_processor)},_changeMode:function(e){var t={};e==="none"?t={name:this.MODES[e],htmlMode:!0}:t=this.MODES[e],Loader.run("mode_"+this.MODES[e],$.proxy(function(){this.editor&&this.editor.setOption("mode",t)},this))},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){"html_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.html_pre_processor)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode(),syntax:"html",profile:"xhtml",autofocus:!0}},getMode:function(){return this.MODES[CP.pen.html_pre_processor]}});"use strict";var JSEditor=BaseEditor.extend({MODES:{none:"javascript",coffeescript:"coffeescript",livescript:"livescript"},_setMode:function(){this._changeMode(CP.pen.js_pre_processor)},getMode:function(){return this.MODES[CP.pen.js_pre_processor]},_changeMode:function(e){var t=this.MODES[e];Loader.run("mode_"+t,$.proxy(function(){this.editor.setOption("mode",t)},this))},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){"js_pre_processor"in t.pen&&this._preProcessorChanged(t.pen.js_pre_processor)},_getEditorTypeSpecificConfig:function(){return{mode:this.getMode()}}});"use strict";var CodeEditorsResizeController=Class.extend({init:function(){this.model=new CodeEditorResizeModel,this.events=new CodeEditorsResizeEvents(this),this.view=new CodeEditorsResizeView(this.model)},setAllEditorsState:function(e){this.model.setAllEditorsState(e)},toggleExpander:function(e){this.model.toggleExpander(e)},toggleCollapser:function(e){this.model.toggleCollapser(e)},syncWithServer:function(e){this.model.syncWithServer(e)}});"use strict";var CodeEditorsResizeEvents=Class.extend({_enabled:!0,$expanderButtons:$(".expander-button-expand"),$collapseButtons:$(".expander-button-collapse"),init:function(e){this.controller=e,this._bindToDOM(),this._bindToHub()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_disableUI:function(){this._enabled=!1},_enableUI:function(){this._enabled=!0},_onServerUIChange:function(e,t){"editorSizes"in t.ui&&this.controller.syncWithServer(t)},_onKey:function(e,t){if(this._enabled&&t.key==="esc"&&window.__keyBindings!=="vim"){var n={state:"normal"};this.controller.setAllEditorsState(n)}},_bindToDOM:function(){this.$expanderButtons._on("click",this._onExpanderClick,this,!0),this.$collapseButtons._on("click",this._onCollapseClick,this,!0)},_onExpanderClick:function(e,t){if(this._enabled){var n={type:t.data("type").toLocaleLowerCase()};this.controller.toggleExpander(n)}},_onCollapseClick:function(e,t){if(this._enabled){var n={type:t.data("type").toLocaleLowerCase()};this.controller.toggleCollapser(n)}}});"use strict";var CodeEditorResizeModel=Class.extend({NORMAL:"normal",COLLAPSED:"collapsed",EXPANDED:"expanded",init:function(){},setAllEditorsState:function(e){this._ensureStateIsValid(e.state),this._setAllTo(e.state),this._publishChangeEvent()},_ensureStateIsValid:function(e){if(e!==this.NORMAL&&e!==this.COLLAPSED&&e!==this.EXPANDED)throw"Bad State: '"+e+"'"},toggleExpander:function(e){this._updateDataAfterToggleExpander(e.type),this._publishChangeEvent()},_updateDataAfterToggleExpander:function(e){CP.ui.editorSizes[e]===this.NORMAL?(this._setAllTo(this.COLLAPSED),CP.ui.editorSizes[e]=this.EXPANDED):CP.ui.editorSizes[e]=this.NORMAL},toggleCollapser:function(e){this._updateDataAfterToggleCollapser(e.type),this._publishChangeEvent()},_updateDataAfterToggleCollapser:function(e){CP.ui.editorSizes[e]===this.NORMAL?CP.ui.editorSizes[e]=this.COLLAPSED:this._setAllTo(this.NORMAL)},_setAllTo:function(e){CP.ui.editorSizes.html=e,CP.ui.editorSizes.css=e,CP.ui.editorSizes.js=e},syncWithServer:function(e){CP.ui.editorSizes=e.ui.editorSizes,this._publishChangeEvent()},_publishChangeEvent:function(){var e={ui:{editorSizes:CP.ui.editorSizes}};Hub.pub("ui-change",e)}});"use strict";var CodeEditorsResizeView=Class.extend({$topBoxes:$(".top-boxes"),$htmlExpand:$("#HTML-expand"),$cssExpand:$("#CSS-expand"),$jsExpand:$("#JS-expand"),$layoutLinks:$(".layout-change-icon"),init:function(e){this.data=e,this._initStateOfEditorLayoutLinks(),this._bindToHub()},_initStateOfEditorLayoutLinks:function(){var e=location.href.split("?");if(e.length>1){var t="?"+e[1];this._updateEditorLayoutLinks(t)}},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){t.ui&&t.ui.editorSizes&&(this._getExpandButton("html").data("state",t.ui.editorSizes.html),this._getExpandButton("css").data("state",t.ui.editorSizes.css),this._getExpandButton("js").data("state",t.ui.editorSizes.js),this._updateURLAndTopBoxesAfterStateChange(t))},_updateURLAndTopBoxesAfterStateChange:function(e){var t=this._getStateClass(e);this._updateURLParamRelated(e),this._setTopBoxesClass(t)},_getStateClass:function(e){var t="state-";return e.ui.editorSizes.html!==this.data.COLLAPSED?t+="htmlOn":t+="htmlOff",e.ui.editorSizes.css!==this.data.COLLAPSED?t+="-cssOn":t+="-cssOff",e.ui.editorSizes.js!==this.data.COLLAPSED?t+="-jsOn":t+="-jsOff",t},_setTopBoxesClass:function(e){var t=this.$topBoxes.attr("class")||"",n=this._replaceCurrentStateClassWithNew(t,e);this.$topBoxes.attr("class",n)},_replaceCurrentStateClassWithNew:function(e,t){return e.match(/state-\S+/)?e.replace(/state-\S+/,t):e+" "+t},_updateURLParamRelated:function(e){var t=this._buildURLParamFromStateClass(e);this._updateEditorStateURL(t),this._updateEditorLayoutLinks(t)},_buildURLParamFromStateClass:function(e){var t="";return e.ui.editorSizes.html!==this.data.COLLAPSED?t+="1":t+="0",e.ui.editorSizes.css!==this.data.COLLAPSED?t+="1":t+="0",e.ui.editorSizes.js!==this.data.COLLAPSED?t+="1":t+="0",t==="111"||t==="000"?"":"?editors="+t},_updateEditorStateURL:function(e){var t=window.location.protocol+"//"+window.location.host+window.location.pathname,n=t+e;history.replaceState("","",n)},_updateEditorLayoutLinks:function(e){_(this.$layoutLinks).forEach(function(t){var n=$(t),r=n.attr("href"),i=r.split("?")[0];n.attr("href",i+e)})},_getExpandButton:function(e){if(e==="html")return this.$htmlExpand;if(e==="css")return this.$cssExpand;if(e==="js")return this.$jsExpand}});"use strict";var TransitionsUtil=Class.extend({_transitionEl:document.createElement("fakeelement"),_transitions:{transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"},init:function(){},getBrowserTransitionEventName:function(){for(var e in this._transitions)if(this._transitionEl.style[e]!==undefined)return this._transitions[e]}});"use strict";var CodeEditorsCSSTransitionHandler=Class.extend({init:function(){this._bindToDOM()},_bindToDOM:function(){$(".box")._on(this._getBrowserTransitionEventName(),this._refreshEditorAtEndOfTransition,this)},_getBrowserTransitionEventName:function(){var e=new TransitionsUtil;return e.getBrowserTransitionEventName()},_refreshEditorAtEndOfTransition:function(){Hub.pub("editor-refresh",{delay:200})}});"use strict";var CodeEditorsUtil={getEditorByType:function(e){return e==="html"?CP.htmlEditor:e==="css"?CP.cssEditor:CP.jsEditor}};"use strict";var CodeEditorsViewSourceController=Class.extend({init:function(){this.model=new CodeEditorsViewSourceModel,this.events=new CodeEditorsViewSourceEvents(this),this.view=new CodeEditorsViewSourceView},toggleViewSource:function(e){this.model.toggleViewSource(e)},syncWithServer:function(e){this.model.syncWithServer(e)}});"use strict";var CodeEditorsViewSourceEvents=Class.extend({_enabled:!0,init:function(e){this.controller=e,this._bindToDOM(),this._bindToHub()},_bindToDOM:function(){$(".view-compiled-button")._on("click",this._toggleViewSource,this)},_bindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_disableUI:function(){this._enabled=!1},_enableUI:function(){this._enabled=!0},_onServerUIChange:function(e,t){"editorViewSource"in t.ui&&this.controller.syncWithServer(t)},_toggleViewSource:function(e,t){if(this._enabled){var n=this._getType(t);if(this._allowedToToggleSourceView(n)){var r={type:n};this.controller.toggleViewSource(r)}else $.showMessage(Copy.cleanErrorsFirst)}},_getType:function(e){var t=$(e).closest("button");return t.data("type").toLowerCase()},_allowedToToggleSourceView:function(e){return!CP.penErrorHandler.editorHasErrors(e)}});"use strict";var CodeEditorsViewSourceModel=Class.extend({init:function(){},toggleViewSource:function(e){var t=this._getSource(e.type)?!1:!0;this._setSource(e.type,t),this._publishChangeEvent(e)},_getSource:function(e){return CP.ui.editorViewSource[e]},_setSource:function(e,t){CP.ui.editorViewSource[e]=t},syncWithServer:function(e){for(var t in e.ui.editorViewSource){CP.ui.editorViewSource[t]=e.ui.editorViewSource[t];var n={type:t};this._publishChangeEvent(n)}},_publishChangeEvent:function(e){var t={ui:{editorViewSource:{}}};t.ui.editorViewSource[e.type]=this._getSource(e.type),Hub.pub("ui-change",t)}});"use strict";var CodeEditorsViewSourceView=Class.extend({init:function(){this._bindToHub()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){if(t.ui&&t.ui.editorViewSource)for(var n in t.ui.editorViewSource)this._toggleViewSource(n,t.ui.editorViewSource[n])},_toggleViewSource:function(e,t){var n=CodeEditorsUtil.getEditorByType(e);t?n.showSource():n.showOriginalCode()}});"use strict";var CMComments={comment:function(e,t){t==="html"?this.commentHTML(e):t==="css"?this.commentCSS(e):t==="js"&&this.commentJS(e)},commentHTML:function(e){CP.pen.html_pre_processor==="slim"?this.prefixComments(e,"/!"):_.contains(["haml","jade"],CP.pen.html_pre_processor)?this.prefixComments(e,"/"):CP.pen.html_pre_processor==="markdown"?this.wrapComments(e,"<!---","--->"):this.wrapComments(e,"<!--","-->")},commentCSS:function(e){this.wrapComments(e,"/*","*/")},commentJS:function(e){_.contains(["coffeescript","livescript"],CP.pen.js_pre_processor)?this.wrapComments(e,"###","###"):this.wrapComments(e,"/*","*/")},prefixComments:function(e,t){var n=e.getSelection().split("\n"),r="",i="",s=!0;for(var o=0;o<n.length;o++)r+=t+n[o],o+1<n.length&&(r+="\n"),n[o].substring(0,t.length)===t?s&&(i+=n[o].substring(t.length,n[o].length),o+1<n.length&&(i+="\n")):s=!1;s?e.replaceSelection(i,"around"):e.replaceSelection(r,"around")},wrapComments:function(e,t,n){var r=e.getSelection(),i="";this.wrappedInComments(r,t,n)?i=r.substring(t.length,r.length-n.length):i=t+r+n,e.replaceSelection(i,"around")},wrappedInComments:function(e,t,n){return e.substr(0,t.length)===t&&e.substr(n.length*-1,n.length)===n}};"use strict";var CMKeyBindings={handleKeydown:function(e,t){this._isTabKeyCombo(t)?this._handleTabOver(e):this._isCommentOutCodeKeyCombo(t)?e.somethingSelected()&&(this._commentOutCode(e),t.preventDefault()):this._isJoinLinesCombo(t)?this._joinLines(e):this._isCloseTagsKeyCombo(t)&&this._closeTags(e)},_isTabKeyCombo:function(e){return Keytrap.getKeyCode("tab")===e.keyCode},_isCommentOutCodeKeyCombo:function(e){return Keytrap.getKeyCode("/")===e.keyCode&&this._isCommandOrControlKey(e)},_isJoinLinesCombo:function(e){return e.keyCode===Keytrap.getKeyCode("j")&&this._isCommandOrControlKey(e)},_isCloseTagsKeyCombo:function(e){return Keytrap.getKeyCode(".")===e.keyCode&&this._isCommandOrControlKey(e)&&e.altKey},_isCommandOrControlKey:function(e){return e.metaKey||e.ctrlKey},_handleTabOver:function(e){var t=TabSnippets.findSnippet(e);t&&this._applySnippetToEntireLine(e,t)},_applySnippetToEntireLine:function(e,t){var n=e.getCursor(),r={line:n.line,ch:0};e.replaceRange(t,r,n)},_commentOutCode:function(e){var t=TypesUtil.cmModeToType(e.getOption("mode"));CMComments.comment(e,t)},_joinLines:function(e){var t=e.getCursor();if(e.lineCount()-1>=t.line+1){var n=e.getLine(t.line)||"",r=e.getLine(t.line+1)||"",i=n+$.trim(r),s={line:t.line,ch:0},o={line:t.line+1,ch:r.length+1};e.replaceRange(i,s,o)}},_closeTags:function(e){this._isHTMLMode(e)&&Loader.run("htmlparser",$.proxy(function(){var t=e.getCursor(),n=t.line+1;while(n--){var r=e.getLine(n),i=/<(?!\/)([^>]+)>/g,s=i.exec(r);if(s){var o="</"+s[1]+">";e.replaceRange(o,t,t);break}}},this))},_isHTMLMode:function(e){return TypesUtil.cmModeToType(e.getOption("mode"))==="html"}};"use strict";var Pen=Class.extend({id:"",title:"",description:"",slug_hash:"",html:"",css:"",js:"",parent:0,"private":!1,auto_run:!0,html_pre_processor:"none",html_classes:"",head:"",css_pre_processor:"none",css_pre_processor_lib:"",css_prefix:"neither",css_starter:"neither",css_external:"",js_pre_processor:"none",js_library:"",js_modernizr:!1,js_external:"",tags:[],_lastUpdatedAt:"",errorCode:"",savingPenToDB:!1,saveAttempts:0,MAX_SAVE_ATTEMPTS:6,SAVE_ATTEMPT_TIMEOUT:1e4,fork:!1,lastSavedPen:{},redirectingToSavedURL:!1,init:function(){_.extend(this,AJAXUtil),this._loadStoredData(),this._ensureDataIsValid(),this._saveDataToLocalStorageOnExit()},_ensureDataIsValid:function(){var e=new PenValidator;e.makePenValid(this),e.makePenValid(this.lastSavedPen)},_saveDataToLocalStorageOnExit:function(){var e=new PenSaver;e.saveDataToLocalStorageOnExit()},_loadStoredData:function(){var e=new PenDataLoader;e.loadStoredData(this),this.savingPenToDB=!1,this.lastSavedPen=this._getLastSavedPenFromThisData()},setPenValue:function(e){for(var t in e.pen)this._setValue(t,e.pen[t]);Hub.pub("pen-change",e)},_setValue:function(e,t){this[e]=t,this._lastUpdatedAt=(new Date).getTime()},getLastUpdatedAt:function(){return this._lastUpdatedAt},getActiveSlugHash:function(){return this.private?this.slug_hash_private:this.slug_hash},newPen:function(){CPLocalStorage.clear(),window.location="/pen"},save:function(){this._canSave()?this._shouldForkPen()?this.forkPenInCurrentState():this.savePenToDB():Hub.pub("pen-errors",this.errorCode)},_shouldForkPen:function(){return!this.isUserPenOwner()},saveAsPrivate:function(){this._canSave()?(this.private=!0,this.savePenToDB()):Hub.pub("pen-errors",this.errorCode)},_canSave:function(){return this.savingPenToDB?(this.errorCode="waiting-to-save-pen",!1):!CP.user.isUserLoggedIn()&&this._isPenConsideredEmpty()?(this.errorCode="anon-cannot-save-empty-pen",!1):!CP.user.isUserLoggedIn()&&this._isProfessorOrCollabSession()?(this.errorCode="anon-cannot-save-during-rt-session",!1):!0},_isProfessorOrCollabSession:function(){return __pageType==="professor"||__pageType==="collab"},forkPenInCurrentState:function(){this.fork=!0,this.parent=this.id,this.savePenToDB()},savePenToDB:function(){if(this._shouldSavePenToDB()){this.savingPenToDB=!0;var e={pen:JSON.stringify(this)};this.post("/pen/save",e,this.doneSave,this.failedSave,this.erroredSave),this.fork=!1}else this.sendPseudoSavedSignal()},_shouldSavePenToDB:function(){return this.hasPenChanged()||!this._hasPenEverBeenSaved()||!this.isUserPenOwner()},sendPseudoSavedSignal:function(){Hub.pub("pen-saved",{})},doneSave:function(e){this.saveAttempts=0,this.savingPenToDB=!1,CPLocalStorage.clear();var t=this._getDiffPen(this,this.lastSavedPen);this.lastSavedPen=this._getLastSavedPenFromThisData();if(e.new_pen_saved)if(this._isProfessorOrCollabSession()){var n={newPen:!0,url:e.redirect_url,pen:t};Hub.pub("pen-saved",n)}else this.redirectingToSavedURL=!0,window.location=e.redirect_url;else{var r={pen:t,last_saved_time_ago:e.last_saved_time_ago};Hub.pub("pen-saved",r)}},failedSave:function(e){this.savingPenToDB=!1,this.showStandardErrorMessage(e)},erroredSave:function(){this.savingPenToDB=!1,this.saveAttempts+=1;if(this.saveAttempts<this.MAX_SAVE_ATTEMPTS){var e=_.template(Copy.errors["unable-to-save-try-again"],{time:TimeUtil.countToString(this.saveAttempts)});$.showMessage(e,"super-slow"),setTimeout($.proxy(this.savePenToDB,this),this.SAVE_ATTEMPT_TIMEOUT)}else this.saveAttempts=0,$.showMessage(Copy.errors["unable-to-save-ever"],"super-slow")},isUserPenOwner:function(){return CP.profiled.is_team?CP.profiled.id===CP.user.current_team_id:CP.profiled.id===CP.user.id},_isPenConsideredEmpty:function(){return this.html===""&&this.css===""&&this.js===""},_hasPenEverBeenSaved:function(){return this.slug_hash!==""},hasPenChanged:function(){return _.size(this._getDiffPen(this,this.lastSavedPen))>0},_getDiffPen:function(e,t){var n={};for(var r in t)r in e&&e[r]!==t[r]&&(n[r]={old:t[r],current:e[r]});return n},_getLastSavedPenFromThisData:function(){return _.pick(this,this.getDataRelevantAttributes())},getDataRelevantAttributes:function(){return["title","description","html","css","js","auto_run","html_pre_processor","html_classes","head","css_pre_processor","css_pre_processor_lib","css_prefix","css_starter","css_external","js_pre_processor","js_library","js_modernizr","js_external","tags","fork","private","parent"]},getAttributesThatAffectPenUI:function(){return["html","css","js","auto_run","html_pre_processor","html_classes","head","css_pre_processor","css_pre_processor_lib","css_prefix","css_starter","css_external","js_pre_processor","js_library","js_modernizr","js_external"]}});"use strict";var PenDataLoader=Class.extend({init:function(){},loadStoredData:function(e){_.extend(e,this._getPensLocalData(),!0),this._setDataThatShouldAlwaysComeFromServer(e),$.removeCookie("use_server_side_values"),CPLocalStorage.clear()},_getPensLocalData:function(){return this._useDataFromLocalStorage()?$.parseJSON(CPLocalStorage.getItem(document.location.pathname)):__pen},_useDataFromLocalStorage:function(){return $.cookie("use_server_side_values")?!1:this._localDataNewerThanServerData()?!0:!1},_localDataNewerThanServerData:function(){var e=!1,t=CPLocalStorage.getItem(document.location.pathname);if(t){var n=this._getComparableClientTime(t);n>__lastUpdated&&(e=!0)}return e},_getComparableClientTime:function(e){var t=$.parseJSON(e),n=t._lastUpdatedAt+"",r=__lastUpdated+"",i=n.substr(0,r.length);return+i},_setDataThatShouldAlwaysComeFromServer:function(e){e.id=__pen.id,e.slug_hash=__pen.slug_hash,e.slug_hash_private=__pen.slug_hash_private,e.parent=__pen.parent,e.private=__pen.private,e.tags=__tags}});"use strict";var PenDelete=Class.extend({init:function(){_.extend(this,AJAXUtil),this._bindToDOM()},_bindToDOM:function(){$(".delete-button")._on("click",this._deletePen,this)},_deletePen:function(){$.showModal("/ajax/confirm_pen_delete","modal-warning",$.proxy(this._deletePenModalCallback,this))},_deletePenModalCallback:function(){$("#confirm-delete")._on("click",this._confirmDeletePen,this)},_confirmDeletePen:function(){this.del("/pen/"+CP.pen.slug_hash,{},this._doneDelete),$.showMessage(Copy.deletingPen,"super-slow"),this._doneDelete()},_doneDelete:function(){window.location=CP.profiled.base_url+"/public"}});"use strict";var PenSaver=Class.extend({init:function(){this.pageType=__pageType},saveDataToLocalStorageOnExit:function(){window.onbeforeunload=$.proxy(function(){if(this._shouldWarnAboutLostWork())return Copy.youHaveUnsavedChanges},this),$(window).unload(function(){CPLocalStorage.setItem(document.location.pathname,JSON.stringify(CP.pen))})},_shouldWarnAboutLostWork:function(){var e=CP.pen.hasPenChanged();return this.pageType==="professor"?e&&this._isProfessorInProfessorRoom():this.pageType==="collab"?e&&this._isPenOwnerInCollabRoom():e&&!CP.pen.redirectingToSavedURL},_isProfessorInProfessorRoom:function(){var e=!1;return this.pageType==="professor"&&typeof CP.professor!="undefined"&&(e=!0),e},_isPenOwnerInCollabRoom:function(){return this.pageType==="collab"?CP.pen.isUserPenOwner():!1}});"use strict";var PenValidator=Class.extend({dataAttributes:{title:{"typeof":"string","default":""},description:{"typeof":"string","default":""},slug_hash:{"typeof":"string","default":""},html:{"typeof":"string","default":""},css:{"typeof":"string","default":""},js:{"typeof":"string","default":""},parent:{"typeof":"number","default":0},"private":{"typeof":"boolean","default":!1},auto_run:{"typeof":"boolean","default":!0},html_pre_processor:{"typeof":["none","haml","markdown","slim","jade"],"default":"none"},html_classes:{"typeof":"string","default":""},head:{"typeof":"string","default":""},css_pre_processor:{"typeof":["none","sass","scss","less","stylus"],"default":"none"},css_pre_processor_lib:{"typeof":"string","default":""},css_prefix:{"typeof":["neither","autoprefixer","prefixfree"],"default":"neither"},css_starter:{"typeof":["neither","normalize","reset"],"default":"neither"},css_external:{"typeof":"string","default":""},js_pre_processor:{"typeof":["none","coffeescript","livescript"],"default":"none"},js_library:{"typeof":["","jquery","jquery_and_jqueryui","zepto","mootools","prototype","yui","extjs","dojo"],"default":""},js_modernizr:{"typeof":"boolean","default":!1},js_external:{"typeof":"string","default":""}},init:function(){},makePenValid:function(e){for(var t in e)this.dataAttributes[t]&&(e[t]=this._getValidAttributeValue(t,e[t]))},_getValidAttributeValue:function(e,t){var n=this.dataAttributes[e];return _.isArray(n["typeof"])?this._getValidArrayAttributeValue(t,n):this._getValidSimpleAttributeValue(t,n)},_getValidArrayAttributeValue:function(e,t){return _.contains(t["typeof"],e)?e:t["default"]},_getValidSimpleAttributeValue:function(e,t){return typeof e===t["typeof"]?e:t["default"]}});"use strict";var Profiled=Class.extend({init:function(){_.extend(this,__profiled)},isUserProfiled:function(e){return this.is_team?!1:e.username===this.username}});"use strict";var UI={buildDefaultUIData:function(){return{info:"closed",layout:window.__layoutType,editorViewSource:{html:!1,css:!1,js:!1},scrollTopLine:{html:{},css:{},js:{}},textSelection:{html:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}},css:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}},js:{start:{line:0,ch:0,xRel:0},end:{line:0,ch:0,xRel:0}}},editorSizes:{html:"normal",css:"normal",js:"normal"},externalInputs:{html:0,css:1,js:1},settingsPanes:{html:"closed",css:"closed",js:"closed"}}}};"use strict";var User=Class.extend({init:function(){_.extend(this,__user)},isUserLoggedIn:function(){return+this.id>1}});"use strict";var AdminStar=Class.extend({init:function(){_.extend(this,AJAXUtil),this._bindToDOM()},_bindToDOM:function(){$("#admin-star")._on("click",this._toggleStar,this)},_toggleStar:function(){this.post("/admin/make_editors_pick",{id:CP.pen.id},this._dataStarred)},_dataStarred:function(){var e=$("#admin-star");$.trim(e.html())==="☆"?e.html("★"):e.html("☆")}});"use strict";var InfoController=Class.extend({init:function(){this.adminStar=new AdminStar,this.model=new InfoModel,this.events=new InfoEvents(this),this.view=new InfoView(this.model)},syncWithServer:function(e){this.model.syncWithServer(e)},toggle:function(e){this.model.toggle(e)},hide:function(e){this.model.hide(e)},hideOnly:function(){this.view.hideOnly()},savePen:function(){CP.pen.save()},savePenAsPrivate:function(){CP.pen.saveAsPrivate()},fork:function(){CP.pen.forkPenInCurrentState()},runPen:function(){CP.penRenderer.processAndRender()},setTitle:function(e){CP.pen.setPenValue(e)},setDescription:function(e){CP.pen.setPenValue(e)},setPenPrivacy:function(e){CP.pen.setPenValue(e)}});"use strict";var InfoEvents=Class.extend({$body:$("body"),$saveDetailsButton:$("#save-details"),$title:$("#pen-details-title"),$description:$("#pen-details-description"),$privateCkbx:$("#pen-details-private"),$penTags:$("#pen-tags"),MAX_TAGS:5,savedTags:[],_tagsWaitingToBeDeleted:[],init:function(e){this.controller=e,this.savedTags=CP.pen.tags.slice(0),this._bindToDOM(),this._bindToHub()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("pen-saved",$.proxy(this._onPenSaved,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this))},_onPenSaved:function(){this._updateTagsOnSave()},_onServerUIChange:function(e,t){"info"in t.ui&&this.controller.syncWithServer(t)},_bindToDOM:function(){$("#edit-details")._on("click",this._toggle,this),$(".edit-details-reminder")._on("click",this._toggle,this),_hideElementWhenUserClicksAway("#pen-details",$.proxy(this._hide,this)),$("#pen-details-title").on("keyup",$.proxy(this._setTitle,this)),$("#pen-details-description").on("keyup",$.proxy(this._setDescription,this)),$("#pen-details-private")._on("click",this._setPenPrivacy,this,!0),this.$body.on("click","#active-tags span span.tag-x",$.proxy(this._handleTagDelete,this)),this.$penTags._on("keyup",this._onTagChange,this),$("#save, #update")._on("click",this._savePen,this),$("#save-as-private")._on("click",this._savePenAsPrivate,this),$("#pen-details-form")._on("submit",this._savePen,this),$("#fork")._on("click",this._fork,this),$("#run")._on("click",this._runPen,this)},_onKey:function(e,t){t.key==="esc"&&this._hide()},_hide:function(){var e={origin:"client"};this.controller.hide(e)},_toggle:function(){var e={origin:"client"};this.controller.toggle(e)},_savePen:function(){this.controller.savePen()},_savePenAsPrivate:function(){this.controller.savePenAsPrivate()},_fork:function(){this.controller.fork()},_runPen:function(){this.controller.runPen()},_setTitle:function(){var e={origin:"client",pen:{title:this.$title.val()}};this.controller.setTitle
(e)},_setDescription:function(){var e={origin:"client",pen:{description:this.$description.val()}};this.controller.setDescription(e)},_setPenPrivacy:function(){var e={origin:"client",pen:{"private":this.$privateCkbx.is(":checked")}};this.controller.setPenPrivacy(e)},_onTagChange:function(e,t){this.forceLowerCasingOnTags(t);var n=this.without(this.savedTags,this._tagsWaitingToBeDeleted),r=this.getSavedAndUnsavedTags(n);this._updateTagHTML(r,n),CP.pen.setPenValue({origin:"client",pen:{tags:r}})},forceLowerCasingOnTags:function(e){var t=_stripHTMLTags(e.val());e.val(t.toLowerCase())},getSavedAndUnsavedTags:function(e){var t=e.slice(0),n=_stripHTMLTags(this.$penTags.val()).split(",");for(var r=0;r<n.length;r++){var i=$.trim(n[r]);i&&t.push(i.toLowerCase());if(t.length>=this.MAX_TAGS){$("#max-tags-label").addClass("at-capacity");break}$("#max-tags-label").removeClass("at-capacity")}return _.uniq(t)},_updateTagHTML:function(e,t){var n=this._getTagHTML(e,t);$("#active-tags").html(n)},_getTagHTML:function(e,t){var n="";for(var r=0;r<e.length;r++)if(e[r]){var i=t.indexOf(e[r])>-1?"saved_tag":"";n+="<span class='tag '"+i+">",n+="<span class='tag-x'>×</span> ",n+="<span class='tag-name'>"+e[r]+"</span> ",n+="</span> "}return n},_handleTagDelete:function(e){e.preventDefault();var t=$(e.target),n=$.trim(t.next().html());return t.parent().remove(),this.updateTagAfterDeletion(n),!1},updateTagAfterDeletion:function(e){this._tagsWaitingToBeDeleted.push(e);var t=this.without(this.savedTags,this._tagsWaitingToBeDeleted);CP.pen.setPenValue({origin:"client",pen:{tags:t}})},without:function(e,t){var n=[];return $.each(e,function(e,r){t.indexOf(r)===-1&&n.push(r)}),n},_updateTagsOnSave:function(){this.$penTags.val(""),this._tagsWaitingToBeDeleted=[],this.savedTags=CP.pen.tags.slice(0),this._updateTagHTML(this.savedTags,this.savedTags)}});"use strict";var InfoModel=Class.extend({CLOSED:"closed",OPEN:"open",init:function(){this.pageType=__pageType},toggle:function(e){CP.ui.info===this.CLOSED?CP.ui.info=this.OPEN:CP.ui.info=this.CLOSED,this._pubUIChange(e)},hide:function(e){CP.ui.info=this.CLOSED,this._pubUIChange(e)},syncWithServer:function(e){CP.ui.info=e.ui.info,this._pubUIChange(e)},_pubUIChange:function(e){var t={origin:e.origin,ui:{info:CP.ui.info}};Hub.pub("ui-change",t)}});"use strict";var InfoView=Class.extend({$body:$("body"),$saveDetailsButton:$("#save-details"),$showInfoViewPane:$("#pen-details"),$showInfoViewTitle:$("#pen-details-title"),$penTags:$("#pen-tags"),$lastSavedTimeAgo:$("#last-saved-time-ago"),$detailsTitle:$("#details-title"),init:function(e){this.pageType=__pageType,this.model=e,this._bindToHub()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this)),Hub.sub("pen-saved",$.proxy(this._onPenSaved,this)),Hub.sub("pen-change",$.proxy(this._onPenChange,this)),Hub.sub("pen-errors",$.proxy(this._onPenErrors,this))},_onUIChange:function(e,t){"info"in t.ui&&this._updateInfoView(t.ui.info)},_updateInfoView:function(e){$.hideMessage(),CP.shareView.hideShareView(),e===this.model.OPEN?this._showInfoView():this._hideInfoView()},_showInfoView:function(){this.$showInfoViewTitle.focus(),this.$showInfoViewPane.slideDown(100)},_hideInfoView:function(){this.$showInfoViewPane.slideUp(100)},hideOnly:function(){this._hideInfoView()},_onPenChange:function(e,t){this._showPenHasUnsavedChanges(),"title"in t.pen&&(document.title=t.pen.title,this.$detailsTitle.html(t.pen.title)),"private"in t.pen&&this._updateBrowserURL()},_showPenHasUnsavedChanges:function(){this.$body.addClass("unsaved"),this.$saveDetailsButton.attr("disabled",!1)},_hidePenHasUnsavedChanges:function(){this.$body.removeClass("unsaved"),this.$saveDetailsButton.attr("disabled",!0)},_updateBrowserURL:function(){if(window.history.replaceState){var e=URLBuilder.getViewURL(this.pageType,CP.profiled,CP.pen,!1);window.history.replaceState(e,"",e)}},_onPenErrors:function(e,t){$.showMessage(Copy.errors[t])},_onPenSaved:function(e,t){this._isNewPenInProfessorOrCollab(t)?$.showMessage(_.template(Copy.penForked,t),8e3):($.showMessage(Copy.penUpdated),this._hidePenHasUnsavedChanges(),this._shouldHideInfoView(t)&&this._hideInfoView(),this._updateTabs(),this._updateSavedTimeAgoFooter())},_isNewPenInProfessorOrCollab:function(e){return _.contains(["professor","collab"],this.pageType)&&e.newPen},_shouldHideInfoView:function(e){return!e.pen||"private"in e.pen?!1:!0},_updateTabs:function(){this.pageType==="details"&&window.location.reload()},_updateSavedTimeAgoFooter:function(){this.$lastSavedTimeAgo.html(CP.pen.last_saved_time_ago)}});"use strict";var KeyBindings=Class.extend({$overlay:$("#overlay"),$keyCommands:$("#keycommands"),$keyCommandsButton:$(".keyboard-commands-button"),init:function(){this._bindToDOM(),this._bindToKeyCombos(),this._bindToCodeMirrorCommands()},_bindToCodeMirrorCommands:function(){__keyBindings==="vim"&&(CodeMirror.commands.save=function(){CP.pen.save()})},_bindToDOM:function(){_hideElementWhenUserClicksAway("#keycommands",$.proxy(this.hideKeyCommandsModal,this)),this.$keyCommandsButton._on("click",$.proxy(this.toggleKeyCommandsModal,this)),this.$overlay.on("click",$.proxy(this.hideKeyCommandsModal,this)),navigator.appVersion.indexOf("Mac")!==-1?$("body").addClass("mac"):$("body").addClass("pc")},toggleKeyCommandsModal:function(){this.$keyCommands.toggle(),this.$overlay.toggle()},showKeyCommandsModal:function(){this.$keyCommands.show(),this.$overlay.show()},hideKeyCommandsModal:function(){this.$keyCommands.hide(),this.$overlay.hide()},triggerKeyEvent:function(e){Keytrap.trigger({},e)},_bindToKeyCombos:function(){Keytrap.bind("esc",function(){$.hideMessage(),Hub.pub("key",{key:"esc"})},!0),Keytrap.bind("comctrl+e",function(){$("#new-comment").focus()},!0),Keytrap.bind("comctrl+s",function(){CP.pen.save()},!0),Keytrap.bind("comctrl+shift+s",function(){CP.pen.saveAsPrivate()},!0),Keytrap.bind("comctrl+p",function(){CP.pen.newPen()},!0),Keytrap.bind("comctrl+shift+5",function(){CP.penRenderer.processAndRender()},!0),Keytrap.bind("comctrl+shift+0",function(){if(CP.pen.slug_hash){var e=document.location.href.replace("/pen/","/full/");window.open(e)}},!0),Keytrap.bind("comctrl+shift+9",function(){$.hideMessage(),KeyBindings.showKeyCommandsModal()},!0),Keytrap.bind("comctrl+i",function(){CP.infoController.toggle()},!0)}});"use strict";var TabSnippets={snippets:{html:{},css:{},js:{}},loadSnippet:function(e){var t=this.getPreProcessorType(e);if(typeof this.snippets[e][t]=="undefined"&&t){var n="/assets/editor/other/snippets/"+t+".js";$.getScript(n,function(){TabSnippets.snippets[e][t]=window["__snippet_"+t].snippets})}},findSnippet:function(e){var t=this.getMode(e),n=this.getPreProcessorType(t),r=e.getCursor(),i=e.getLine(r.line),s=$.trim(i.substring(0,r.ch));if(typeof this.snippets[t][n]!="undefined")for(var o in this.snippets[t][n])if($.trim(s)===o)return this.snippets[t][n][o];return!1},getMode:function(e){return TypesUtil.cmModeToType(e.getOption("mode"))},getPreProcessorType:function(e){var t=CP.pen[e+"_pre_processor"];return t==="none"?e:t}};"use strict";var ClientSidePenValidations={validate:function(e,t){return this.validateHTML(e,t),this.validateCSS(e,t),t},validateHTML:function(e,t){var n=/^(\s+)?<!doctype/i;n.test(e.html)&&(t.html={line:1,type:"html",message:"You don't need a DOCTYPE on CodePen. Just put here what you would normally put in the <body>.",level:"warn",pretty_name:"HTML"})},validateCSS:function(e,t){if(_.contains(["scss","sass"],e.css_pre_processor)){var n=/inline-image/i;n.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,n),type:"css",message:'The function inline-image can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"});var r=/image-width/i;r.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,r),type:"css",message:'The function image-width can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"});var i=/image-height/i;i.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,i),type:"css",message:'The function image-height can not be used on CodePen since it depends on reading images from disk. We"ve removed it.',level:"warn",pretty_name:"SCSS"})}if(e.css_pre_processor==="less"){var s=/data-uri/i;s.test(e.css)&&(t.css={line:this._findErrorLineNumber(e.css,s),type:"css",message:'The function data-uri can not be used because it"s insecure. We"ve removed it from your LESS code.',level:"warn",pretty_name:"LESS"})}},_findErrorLineNumber:function(e,t){var n=e.split("\n");for(var r=0,i=n.length;r<i;r++)if(t.test(n[r]))return r+1;return 1}};"use strict";var PenErrorHandler=Class.extend({editorErrorData:{},init:function(){this.initEditorErrorData(),this.bindToElements()},initEditorErrorData:function(){_.each(["html","css","js"],function(e){this.editorErrorData[e]={preprocErrors:[],preprocErrorLineNums:[]}},this)},bindToElements:function(){$(".editor-parent").on("click",".error-icon",$.proxy(this.toggleSingleInlineError,this))},toggleSingleInlineError:function(e){var t=$(e.target).closest("div.box").data("type");$("#box-"+t+" .inline-editor-error").removeClass("inline-error-hidden"),t=$(e.target).data("type"),this.jumpToFirstError(t),this.hideErrorBar(t),Hub.pub("editor-refresh",{delay:0})},canStillRenderPen:function(e){var t=!0;for(var n in e){var r=e[n];if(r.level==="error"){t=!1;break}}return t},previousShowErrorsInEditorTimeoutID:0,handleErrorsInEditor:function(e){this.clearPreviousCallToEditorErrors(),this.clearPreprocWidgets("all"),_.size(e)&&this.showErrorsInEditor(e)},clearPreviousCallToEditorErrors:function(){clearTimeout(this.previousShowErrorsInEditorTimeoutID)},clearPreprocWidgets:function(e){e==="all"?_.each(["html","css","js"],function(e){this.clearPreprocWidgetsOfType(e)},this):this.clearPreprocWidgetsOfType(e),this.hideErrorBar()},clearPreprocWidgetsOfType:function(e){var t=CodeEditorsUtil.getEditorByType(e),n=this.editorErrorData[e].preprocErrors,r=this.editorErrorData[e].preprocErrorLineNums;for(var i=0,s=n.length;i<s;i++){n[i].clear();var o=r[i]-1;t.editor.removeLineClass(o,"background")}this.editorErrorData[e].preprocErrors=[],this.editorErrorData[e].preprocErrorLineNums=[]},showErrorsInEditor:function(e){this.previousShowErrorsInEditorTimeoutID=setTimeout($.proxy(function(){this.showPreprocessorErrors(e)},this),this.inlineErrorTimeout)},showPreprocessorErrors:function(e){for(var t in e){var n=TypesUtil.syntaxToType(t);CP.penRenderer.setPostProcessed(n,"");var r=CodeEditorsUtil.getEditorByType(n),i=e[t],s=this.addInlineEditorWidget(r.editor,i.line,i.message);this.editorErrorData[n].preprocErrors.push(s),this.editorErrorData[n].preprocErrorLineNums.push(i.line),this.showErrorBar(n)}},addInlineEditorWidget:function(e,t,n){var r="<div class='inline-editor-error inline-error-hidden'><div class='inline-error-message'><%= message %></div></div>",i=_htmlEntities(n),s=_.template(r,{message:i}),o=$(s)[0],u=parseInt(t-1,10);e.addLineClass(u,"background","line-highlight");var a={coverGutter:!0,noHScroll:!0};return e.addLineWidget(u,o,a)},jumpToFirstError:function(e){var t=this.editorErrorData[e].preprocErrorLineNums,n=this.getErrorLineNumberToScrollTo(t[0]);CodeEditorsUtil.getEditorByType(e).editor.scrollIntoView(n)},getErrorLineNumberToScrollTo:function(e){return e-2>0?e-2:0},showErrorBar:function(e){$("#error-bar-"+e).show()},hideErrorBar:function(e){e?$("#error-bar-"+e).hide():$(".error-bar").hide()},editorHasErrors:function(e){return this.editorErrorData[e].preprocErrors.length}});"use strict";var BunkerBox={makeHeadSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),t==="public"&&(e=e.replace(/<script.+/mgi,"")),e=this.makeHTMLSafe(e,t),e},makeHTMLSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),e=e.replace(/(<.*?\s)(autofocus)/g,"$1"),e=e.replace(/src=.+(&#)/gmi,""),e=e.replace(/autoPlay=true/gmi,"autoPlay=false"),e=e.replace(/http-equiv="refresh"/gmi,""),t==="public"&&(e=this._makeHTMLSafeForPublic(e)),e=this.makeJSSafe(e,t),e},_makeHTMLSafeForPublic:function(e){var t=e.replace(/(\s+)(action=)("|")([\S]+)("|")/gim,"$1$2$3#$5");return t},makeJSSafe:function(e,t){return e=e||"",t=this._getSafeSandboxType(t),e=e.replace(/location\.replace/gmi,""),e=e.replace(/location\.reload/gmi,""),e.match(/download(\s+)?=/mi)&&e.match(/createObjectURL/mi)&&(e=e.replace(/download(\s+)?=/gmi,""),e=e.replace(/createObjectURL/gmi,"")),t==="public"&&(e=e.replace((/beforeunload/gmi,"beforeunloadreplacedbycodepen")),e=e.replace(/debugger(\s+)?;/gmi,""),e=e.replace(/alert/gmi,""),e=e.replace(/geolocation/gmi,"")),this._isSandboxSupported()||(e=e.replace(/window(\s+)?\[(\s+)?("|")l/gmi,""),e=e.replace(/self(\s+)?\[(\s+)?("|")loc/gmi,""),e=e.replace(/\.submit\(\)/gmi,""),e=e.replace(/fromCharCode/gmi,""),e=e.replace(/\blocation(\s+)?=/gmi,"")),e},_getSafeSandboxType:function(e){return typeof e=="undefined"?"public":e==="public"?"public":"personal"},_sandboxSupported:null,_isSandboxSupported:function(){return this._sandboxSupported===null&&(this._sandboxSupported=this._determineIfSanboxIsSupported()),this._sandboxSupported},_determineIfSanboxIsSupported:function(){try{return"sandbox"in document.createElement("iframe")}catch(e){return!1}}};"use strict";var IFramePenToHTML={renderPenAsHTML:function(e){var t=[];return t.push(this.getHTMLStart(e)),t.push(this.getHeadAndCSS(e)),t.push(this.getHTML(e)),t.push(this._getLinkPostMessageScript()),t.push(this.getJS(e)),t.push(this.getHTMLEnd()),t.join("\n")},getHTMLStart:function(e){return"<!DOCTYPE html><html class='"+e.html_classes+"'>"},getHTMLEnd:function(){return"</body></html>"},getHeadAndCSS:function(e){var t="<head><meta charset='UTF-8'>";t+='<meta name="robots" content="noindex">',t+='<link rel="canonical" href="'+document.location.href+'" />',t+="\n"+e.head+"\n",e.css_starter==="normalize"?t+="<link rel='stylesheet' href='http://s.codepen.io/assets/reset/normalize.css'>":e.css_starter==="reset"&&(t+="<link rel='stylesheet' href='http://s.codepen.io/assets/reset/reset.css'>"),e.js_library==="jquery_and_jqueryui"&&(t+="<link rel='stylesheet' href='http://s.codepen.io/assets/libs/fullpage/jquery-ui.css'>"),e.css_prefix==="prefixfree"&&(t+="<script src='http://s.codepen.io/assets/libs/prefixfree.min.js'></script>"),e.js_modernizr&&(t+="<script src='http://s.codepen.io/assets/libs/modernizr.js'></script>");for(var n=0;n<e.resources.length;n++){var r=e.resources[n];r.action==="include_css_url"?_isValidURL(r.url)&&(t+="<link rel='stylesheet prefetch' href='"+r.url+"'>"):r.action==="prepend_as_css"&&(t+="\n<style>"+r.content+"</style>")}return t+="\n<style>"+e.css+"</style>",t+="</head><body>",t},getHTML:function(e){return BunkerBox.makeHTMLSafe(e.html,"personal")},getJS:function(e){return this._isIE9()?this._getJSScripts(e)+"\n<script>setTimeout(function() {"+this.getSafeJS(e.js)+"}, 0);</script>":this._getJSScripts(e)+"\n<script>"+this.getSafeJS(e.js)+"//@ sourceURL=pen.js\n</script>"},_getJSScripts:function(e){var t="";return e.js_library!=="none"&&e.js_library!==""&&(t+=this._getCommonJSScripts(e.js_library)),t+=this._getPenResourcesAsScripts(e.resources),t},_getLinkPostMessageScript:function(){return"<script style='display: none;'>var __links = document.querySelectorAll('a');function __linkClick(e) { parent.window.postMessage(this.href, '*');} ;for (var i = 0, l = __links.length; i < l; i++) {if ( __links[i].getAttribute('target') == '_blank' ) { __links[i].addEventListener('click', __linkClick, false);}}</script>"},_getCommonJSScripts:function(e){var t={jquery:"//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js",jquery_and_jqueryui:"//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js",zepto:"//cdnjs.cloudflare.com/ajax/libs/zepto/1.0/zepto.min.js",mootools:"//ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js",prototype:"//ajax.googleapis.com/ajax/libs/prototype/1.7.1/prototype.js",yui:"//yui.yahooapis.com/3.10.3/build/yui/yui-min.js",extjs:"//cdn.sencha.io/ext-4.2.0-gpl/ext-all.js",dojo:"//ajax.googleapis.com/ajax/libs/dojo/1.9.0/dojo/dojo.js"},n="";return t[e]&&(e==="jquery_and_jqueryui"&&(n+="<script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>"),n+=t[e]?"<script src='"+t[e]+"'></script>":""),n},_getPenResourcesAsScripts:function(e){var t="";for(var n=0,r=e.length;n<r;n++)e[n].action==="include_js_url"?t+="<script src='"+e[n].url+"'></script>":e[n].action==="prepend_as_js"&&(t+="\n<script>"+e[n].content+"</script>");return t},_isIE9:function(){var e=function(){var e,t=3,n=document.createElement("div"),r=n.getElementsByTagName("i");while(n.innerHTML="<!--[if gt IE "+ ++t+"]><i></i><![endif]-->",r[0]);return t>4?t:e}();return e===9},getSafeJS:function(e){return BunkerBox.makeJSSafe(e,"personal")}};"use strict";var IFrameRenderer={penHTMLKey:"",activeIFrameID:"",resultDiv:$("#result_div"),init:function(){this.penHTMLPrefix=__phkPrefix,this.sandboxVal=__sandboxVal,this.figureOutLayout(),_.extend(this,AJAXUtil)},figureOutLayout:function(){$("body").hasClass("layout-right")||$("body").hasClass("layout-left")?this.layoutStyle="side":this.layoutStyle="top"},UPDATE_LIVE_IFRAME_TIMEOUT:400,ACTIVE_LIVE_IFRAME_TIMEOUT:5,lastUpdateLiveIFrameSetTimeoutID:0,updateLiveIFrame:function(e){clearTimeout(this.lastUpdateLiveIFrameSetTimeoutID),this.lastUpdateLiveIFrameSetTimeoutID=setTimeout($.proxy(function(){this._runLiveUpdate(e),this.ACTIVE_LIVE_IFRAME_TIMEOUT=this.UPDATE_LIVE_IFRAME_TIMEOUT},this),this.ACTIVE_LIVE_IFRAME_TIMEOUT)},_runLiveUpdate:function(e){this.penHTMLKey=this._getStorePenHTMLKey();var t=IFramePenToHTML.renderPenAsHTML(e);this._storePenHTMLOnBoomerang(this.penHTMLKey,t)},_storePenHTMLOnBoomerang:function(e,t){var n={html:t,key:e};this.post("/boomerang",n,this._doneStorePenHTMLOnBoomerang)},_doneStorePenHTMLOnBoomerang:function(){this._replaceOldIFrameWithNew()},_getStorePenHTMLKey:function(){return this.penHTMLPrefix+(new Date).getTime()},IFRAME_LOAD_WAIT_TIME:300,updateIFrameTimeoutID:0,_replaceOldIFrameWithNew:function(){this.resultDiv.prepend(this._getIFrameHTML(this.penHTMLKey)),this._showNewIFrameOnload()},_showNewIFrameOnload:function(){$("#result"+this.penHTMLKey).load($.proxy(function(){clearTimeout(this.updateIFrameTimeoutID),this._removeOldIFrameShowNewIFrameClass()},this)),this.updateIFrameTimeoutID=setTimeout($.proxy(function(){this._removeOldIFrameShowNewIFrameClass()},this),this.IFRAME_LOAD_WAIT_TIME)},_removeOldIFrameShowNewIFrameClass:function(){var e=this.resultDiv.children("iframe");for(var t=0,n=e.length;t<n;t++)e[t].id!==this.activeIFrameID&&$(e[t]).remove();$("#"+this.activeIFrameID).removeClass("iframe-visual-update")},_getIFrameWidth:function(){return this.layoutStyle==="top"?$(window).width()+"px":"100%"},_getIFrameHTML:function(e){return"<iframe id='"+this._buildActiveIFrameID(e)+"' "+"src='"+this._getIFrameURL(e)+"' "+"name='CodePen' "+"allowfullscreen='true' sandbox='"+this.sandboxVal+"' "+"allowTransparency='true' class='result-iframe iframe-visual-update' "+"style='height: 100%; width: "+this._getIFrameWidth()+";'></iframe>"},_buildActiveIFrameID:function(e){return this.activeIFrameID="result"+e,this.activeIFrameID},_getIFrameURL:function(e){var t=document.location;return _.template(this._getIFrameURLTemplate(),{key:e,protocol:t.protocol,subdomain:"s.",host:this._getIFrameHost(),search:t.search,hash:t.hash})},_getIFrameHost:function(){return _isOnLocalhost()?"codepen.dev":"codepen.io"},_getIFrameURLTemplate:function(){return"<%= protocol %>//<%= subdomain %><%= host %>/boomerang/<%= key %>/index.html<%= search %><%= hash %>"}};IFrameRenderer.init(),"use strict";var PenRenderer=Class.extend({refHTML:"",refCSS:"",refJS:"",refHTMLPP:"",refCSSPP:"",refCSSPPLib:"",refJSPP:"",postProcessedHTML:"",postProcessedCSS:"",postProcessedJS:"",errors:{},INACTIVITY_TIMEOUT:900,MAX_TIME_BETWEEN_RENDER:3500,LOOP_INACTIVITY_TIMEOUT:400,INLINE_ERROR_TIMEOUT:1e3,_lastProcessAndRender:0,resources:[],init:function(){this.pageType=__pageType,this._attributesThatAffectPenUI=CP.pen.getAttributesThatAffectPenUI(),_.extend(this,AJAXUtil),this.procAndRender=_.throttle($.proxy(this.processAndRender,this),this.INACTIVITY_TIMEOUT),this._bindToHub(),this._loadInitialIframeResult()},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){for(var n in t.pen)_.contains(this._attributesThatAffectPenUI,n)&&this.compileContent()},_loadInitialIframeResult:function(){this.processAndRender()},compileContent:function(){CP.pen.auto_run&&(clearTimeout(this.previousCompileContentTimeoutID),this.ignoreBecauseInLoop()?this.previousCompileContentTimeoutID=setTimeout($.proxy(this.compileContent,this),this.LOOP_INACTIVITY_TIMEOUT):this.previousCompileContentTimeoutID=setTimeout($.proxy(this.processAndRender,this),this._getCompileContentTimeout()))},_getCompileContentTimeout:function(){var e=_getTimeInMilliseconds()-this._lastProcessAndRender;return e>this.MAX_TIME_BETWEEN_RENDER?this.LOOP_INACTIVITY_TIMEOUT:this.INACTIVITY_TIMEOUT},ignoreLoopsRegex:new RegExp("(^|s*)(while|do|for|until)(s*|$)"),ignoreBecauseInLoop:function(){var e=!1;if(CP.jsEditor.hasFocus()){var t=CP.jsEditor.editor.getLine(CP.jsEditor.editor.getCursor().line);e=this.ignoreLoopsRegex.test(t)}return e},setPostProcessed:function(e,t){this["postProcessed"+e.toUpperCase()]=t},getPostProcessed:function(e){return this["postProcessed"+e.toUpperCase()]},processAndRender:function(){this._lastProcessAndRender=_getTimeInMilliseconds(),CP.penResources.processResourcesAndCallback(CP.pen,$.proxy(this.processContentAfterProcessingResources,this))},processContentAfterProcessingResources:function(e){this.resources=e;var t=this.getContentHashThatNeedsToBeProcessed();if(_.isEmpty(t)){var n={};this.handleProcessedPenData(n)}else t=CP.penResources.mergeResourcesAndPen(t,e),this.sendContentToServer(t)},getContentHashThatNeedsToBeProcessed:function(){var e={},t=this;return _.each(["html","css","js"],function(n){t.useCache(n)||(t._needsToBeProcessedOnServer(n)?n==="css"?(e.css=CP.pen.css,e.css_pre_processor=CP.pen.css_pre_processor,e.css_pre_processor_lib=CP.pen.css_pre_processor_lib,e.css_prefix=CP.pen.css_prefix):(e[n]=CP.pen[n],e[n+"_pre_processor"]=CP.pen[n+"_pre_processor"]):t.setPostProcessed(n,CP.pen[n]))}),e},_needsToBeProcessedOnServer:function(e){var t=CP.pen[e+"_pre_processor"];return e==="css"?t&&t!=="none"||CP.pen.css_prefix==="autoprefixer":t&&t!=="none"},sendContentToServer:function(e){this.post("/preprocessors",e,this.doneSendcontentServer)},doneSendcontentServer:function(e){for(var t in e.results)this.setPostProcessed(t,e.results[t]);this.handleProcessedPenData(e.errors)},handleProcessedPenData:function(e){this.errors=ClientSidePenValidations.validate(CP.pen,e),CP.penErrorHandler.handleErrorsInEditor(e),this.finishRendering()},finishRendering:function(){if(CP.penErrorHandler.canStillRenderPen(this.errors)){this.storeRefContent();var e=this.buildRenderablePen();Hub.pub("live_change",e),this.sendIFrameRenderablePen(e)}},buildRenderablePen:function(){var e=CP.penResources.regexReplaceHTMLAfterProcessing(this.postProcessedHTML,this.resources),t={html:e,html_classes:CP.pen.html_classes,head:CP.pen.head,css:this.postProcessedCSS,css_prefix:CP.pen.css_prefix,css_starter:CP.pen.css_starter,js:this.postProcessedJS,js_library:CP.pen.js_library,js_modernizr:CP.pen.js_modernizr,location_hash:window.location.hash,resources:this.resources,auto_run:CP.pen.auto_run};for(var n in t)t[n]=t[n]||"";return t},sendIFrameRenderablePen:function(e){IFrameRenderer.updateLiveIFrame(e)},storeRefContent:function(){this.refHTML=CP.pen.html,this.refHTMLPP=CP.pen.html_pre_processor,this.refCSS=CP.pen.css,this.refCSSPP=CP.pen.css_pre_processor,this.refCSSPPLib=CP.pen.css_pre_processor_lib,this.refCSSPrefix=CP.pen.css_prefix,this.refJS=CP.pen.js,this.refJSPP=CP.pen.js_pre_processor},useCache:function(e){return _.size(this.errors)?!1:e==="html"?this.refHTML===CP.pen.html&&this.refHTMLPP===CP.pen.html_pre_processor&&!this.hasResourceTypeWithAction("regex_replace")&&!this.hasResourceTypeWithAction("regex_replace_before_processing")?!0:(this.setPostProcessed(e,""),!1):e==="css"?this.refCSS===CP.pen.css&&this.refCSSPP===CP.pen.css_pre_processor&&this.refCSSPPLib===CP.pen.css_pre_processor_lib&&this.refCSSPrefix===CP.pen.css_prefix&&!this.hasResourceTypeWithAction("prepend_to_css")?!0:(this.setPostProcessed(e,""),!1):this.refJS===CP.pen.js&&this.refJSPP===CP.pen.js_pre_processor&&!this.hasResourceTypeWithAction("prepend_to_js")?!0:(this.setPostProcessed(e,""),!1)},hasResourceTypeWithAction:function(e){for(var t=0;t<this.resources.length;t++)if(this.resources[t].action===e)return!0;return!1}});"use strict";var PenResources=Class.extend({cachedResources:{},init:function(){_.extend(this,AJAXUtil)},processResourcesAndCallback:function(e,t){var n=e.html,r=ExternalsUtil.getExternalsAsArray(e.css_external),i=ExternalsUtil.getExternalsAsArray(e.js_external),s=this._findResourcesNeedingToBeProcess(n,r,i);this._needsToBeSentForProcessing(s)?this._processResourcesAndRunCallback(e,t):this._useCachedResources(s)?t(_.values(this.cachedResources)):t(this._convertSimpleCSSJSURLsToResourceObjects(r,i))},_findResourcesNeedingToBeProcess:function(e,t,n){var r={};return r=_.extend(r,this._getHTMLResourcesToProcess(e)),r=_.extend(r,this._getCSSAndJSResourcesToProcess("css",t)),r=_.extend(r,this._getCSSAndJSResourcesToProcess("js",n)),r},_getHTMLResourcesToProcess:function(e){var t={},n=/\[\[\[\S+\]\]\]/mg,r=r=n.exec(e);while(r)t[this._getResourceKey("html",r[0])]=r[0],r=r=n.exec(e);return t},_getCSSAndJSResourcesToProcess:function(e,t){var n={};return _.each(t,$.proxy(function(t){this._isURLResourceNeedingProcessing(t)&&(n[this._getResourceKey(e,t)]=t)},this)),n},_isURLResourceNeedingProcessing:function(e){return this._urlRefersToPenURL(e)||this._urlRefersToCSSNeedingToBePreprocessed(e)||this._urlRefersToJSNeedingToBePreprocessed(e)},_urlRefersToPenURL:function(e){return/\/\S+\/pen\/\w{5,}$/i.test(e)},_urlRefersToCSSNeedingToBePreprocessed:function(e){return/\.(scss|sass|less|stylus)$/i.test(e)},_urlRefersToJSNeedingToBePreprocessed:function(e){return/\.(coffeescript|livescript)$/i.test(e)},_getResourceKey:function(e,t){return e+"_"+t},_needsToBeSentForProcessing:function(e){return _.isEmpty(e)?!1:!this._hasAllResourcesNeedingToBeProcessedCached(e)},_processResourcesAndRunCallback:function(e,t){var n="/process_external_resources",r=this._getProcessResourcesParams(e);this.post(n,r,$.proxy(function(e){this._doneProcessExternalResources(e,t)},this))},_getProcessResourcesParams:function(e){return{html_pre_processor:e.html_pre_processor,html:e.html,css_pre_processor:e.css_pre_processor,css_pre_processor_lib:e.css_pre_processor_lib,css_prefix:e.css_prefix,css_external:e.css_external,js_pre_processor:e.js_pre_processor,js_external:e.js_external}},_doneProcessExternalResources:function(e,t){var n=JSON.parse(e.resources);this._cacheResources(n),t(n)},_cacheResources:function(e){this.cachedResources={};for(var t=0,n=e.length;t<n;t++)this.cachedResources[this._getCacheResourceKey(e[t])]=e[t]},_getCacheResourceKey:function(e){var t=TypesUtil.syntaxToType(e.type),n=e.url?e.url:e.text_to_replace;return t+"_"+n},_useCachedResources:function(e){return _.size(e)===0?!1:this._hasAllResourcesNeedingToBeProcessedCached(e)},_hasAllResourcesNeedingToBeProcessedCached:function(e){var t=_.keys(this.cachedResources),n=_.keys(e),r=_.difference(n,t);return r.length===0},_convertSimpleCSSJSURLsToResourceObjects:function(e,t){var n=[];return _.each(e,function(e){e&&n.push({action:"include_css_url",url:e})}),_.each(t,function(e){e&&n.push({action:"include_js_url",url:e})}),n},mergeResourcesAndPen:function(e,t){e.html&&(e.html=this._regexReplaceHTMLBeforeProcessing(e.html,t));var n=this._getPrependFromResources("css",t);n&&(e.css=n+e.css);var r=this._getPrependFromResources("js",t);return r&&(e.js=r+e.js),e},_getPrependFromResources:function(e,t){var n="";for(var r=0,i=t.length;r<i;r++)t[r].action==="prepend_to_"+e&&(n+=t[r].content+"\n",e==="js"&&(n+=";"));return n},regexReplaceHTMLAfterProcessing:function(e,t){return this._regexReplaceHTML(e,"regex_replace",t)},_regexReplaceHTMLBeforeProcessing:function(e,t){return this._regexReplaceHTML(e,"regex_replace_before_processing",t)},_regexReplaceHTML:function(e,t,n){for(var r=0;r<n.length;r++)if(n[r].action===t){var i=n[r].text_to_replace;i=i.replace(/\//g,"\\/"),i=i.replace(/\[/g,"\\["),i=i.replace(/\]/g,"\\]");var s=new RegExp(i,"g");e=e.replace(s,n[r].content)}return e}});"use strict";var RTClient=Class.extend({fayeClient:null,onConnectFuncs:[],onFailFuncs:[],connect:function(e,t,n){this._storeClientFuncs(t,n),this._connectToFaye(e)},_connectToFaye:function(e){var t=_.bind(this._onConnected,this),n=_.bind(this._onFailedToConnect,this);RTClientConnect.connect(e,t,n)},_onConnected:function(e){this.fayeClient=e,this._callOnConnectFuncs()},_onFailedToConnect:function(){this._callOnFailFuncs()},_storeClientFuncs:function(e,t){typeof e=="function"&&this.onConnectFuncs.push(e),typeof t=="function"&&this.onFailFuncs.push(t)},_callOnConnectFuncs:function(){var e=this.onConnectFuncs.pop();while(e)e(),e=this.onConnectFuncs.pop()},_callOnFailFuncs:function(){var e=this.onFailFuncs.pop();while(e)e(),e=this.onFailFuncs.pop()},showStandardUnableToConnectWarning:function(){$.showModal("/ajax/realtime/unable_to_connect","modal-warning modal-single-message")},publish:function(e,t,n){var r={type:e,data:n,rtData:t},i=this._getPublicationChannel(e,t);return this.fayeClient.publish(i,r)},_getPublicationChannel:function(e,t){return this._getPubSubChannel("client",e,t)},subscribe:function(e,t,n){var r=this._getSubscriptionChannel(e,t);return this.fayeClient.subscribe(r,$.proxy(function(e){this._shouldHandleEvent(t,e)&&n(e)},this))},_shouldHandleEvent:function(e,t){return t.pubType==="allButSender"?e.rtClientID!==t.rtData.rtClientID:t.pubType==="sender"?e.rtClientID===t.rtData.rtClientID:t.pubType==="all"?!0:!1},_getSubscriptionChannel:function(e,t){return this._getPubSubChannel("server",e,t)},unsubscribe:function(e,t){var n=this._getSubscriptionChannel(e,t);this.fayeClient.unsubscribe(n)},_getPubSubChannel:function(e,t,n){var r=this._getChannel(n);return _.template(r,{type:t,originType:e,roomType:n.roomType,slugHash:n.pen.slugHash})},_getChannel:function(e){return typeof e.channel=="string"?e.channel:"/rt/<%= originType %>/<%= roomType %>/<%= slugHash %>/<%= type %>"}});"use strict";var RTClientConnect={_fayeOptions:{timeout:30,retry:5},fayeClient:!1,connect:function(e,t,n){this.fayeClient?t(this.fayeClient):this._swarmWSConnectionsAndConnectToFaye(e,t,n)},FAYE_PORT_1:"8080",FAYE_PORT_2:"80",FAYE_PORT_3:"443",foundPortToConnectTo:!1,WS_CONNECT_TIMEOUT:1e3,WS_STAGGER_TIMEOUT:300,_swarmWSConnectionsAndConnectToFaye:function(e,t,n){try{var r=this,i=new WebSocket(this._getURLToWS(this.FAYE_PORT_1));i.port=this.FAYE_PORT_1,setTimeout(function(){r.foundPortToConnectTo===!1&&(r.foundPortToConnectTo=!0,r._connectedToFayeAfterFindingURL(r.FAYE_PORT_1,e,t,n))},this.WS_CONNECT_TIMEOUT),i.onopen=function(){r._callConnectToFaye(this,e,t,n)},i.onerror=r._handleWSOnError,setTimeout(function(){if(r.foundPortToConnectTo===!1){var i=new WebSocket(r._getURLToWS(r.FAYE_PORT_2));i.port=r.FAYE_PORT_2,i.onopen=function(){r._callConnectToFaye(this,e,t,n)},i.onerror=r._handleWSOnError}},this.WS_STAGGER_TIMEOUT),setTimeout(function(){if(r.foundPortToConnectTo===!1){var i=new WebSocket(r._getURLToWS(r.FAYE_PORT_3));i.port=r.FAYE_PORT_3,i.onopen=function(){r._callConnectToFaye(this,e,t,n)},i.onerror=r._handleWSOnError}},this.WS_STAGGER_TIMEOUT*2)}catch(s){this.foundPortToConnectTo=!0,this._connectedToFayeAfterFindingURL(this.FAYE_PORT_1,e,t,n)}},_callConnectToFaye:function(e,t,n,r){e.close(),this.foundPortToConnectTo=!0,this._connectedToFayeAfterFindingURL(e.port,t,n,r)},_handleWSOnError:function(){this.close()},_connectedToFayeAfterFindingURL:function(e,t,n){function i(){n(this)}var r=this._buildFayeClient(t,e);r.on("transport:up",i),r.on("transport:down",this._handleFailedConnect);var s="/rt/server/anyRoom/anySlugHash/ping";r.subscribe(s,_.noop)},_buildFayeClient:function(e,t){var n=this._getURLToNode(t),r=new Faye.Client(n,this._fayeOptions);return r.addExtension({outgoing:function(t,n){t.rtData=e,n(t)}}),r},_handleFailedConnect:function(){_isOnLocalhost()&&RTClientConnect.fayeClient===!1},_getURLToWS:function(e){return _.template(this._getURLToWSTemplate(),this._getTemplateValues(e))},_getURLToWSTemplate:function(){return"ws://<%= subdomain %>.<%= hostname %>:<%= port %>/rt"},_getURLToNode:function(e){return _.template(this._getURLTemplate(),this._getTemplateValues(e))},_getURLTemplate:function(){return"<%= protocol %>//<%= subdomain %>.<%= hostname %>:<%= port %>/rt"}
,_getTemplateValues:function(e){var t=document.location;return{subdomain:"rt2",port:e,protocol:t.protocol,hostname:t.hostname}}};"use strict";var BaseSettingsController=Class.extend({setPenValue:function(e){this.pen.setPenValue(e)},toggleSettingsPane:function(){this.model.toggleSettingsPane()},hideSettingsPane:function(e){this.model.hideSettingsPane(e)},syncWithServer:function(e){this.model.syncWithServer(e)},addExternalResource:function(){this.model.addExternalResource()}});"use strict";var BaseSettingsEvents=Class.extend({type:"",_enabled:!0,$allEls:$(".settings input, .settings textarea, .settings select, .settings button"),init:function(e){this.controller=e,this._baseBindToDOM(),this._baseBindToHub()},_baseBindToDOM:function(){$(this._getToggleSettingsPaneSelector())._on("click",this._toggleSettingsPane,this),_hideElementWhenUserClicksAway(this._getHideElementsSelector(),$.proxy(this._hideSettingsPane,this)),$(".add-resource[data-type='"+this.type+"']").on("click",$.proxy(this._onAddResourceClick,this)),$("body").on("keyup change","."+this.type+"-resource",$.proxy(this._onExternalResource,this))},_getToggleSettingsPaneSelector:function(){return"#box-"+this.type+" .settings-nub,#settings-pane-"+this.type},_getHideElementsSelector:function(){return"#box-"+this.type+" .settings, "+" #box-"+this.type+" .settings-nub"},_onAddResourceClick:function(){this._enabled&&this.controller.addExternalResource()},_onExternalResource:function(e){if(this._enabled){var t={origin:"client",pen:{}};t.pen[this.type+"_external"]=this._getExternalsValue(),this.controller.setPenValue(t)}},_getExternalsValue:function(){var e=_.map($("."+this.type+"-resource"),function(e){return e.value});return e.join(";")},_baseBindToHub:function(){Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this)),Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("server-ui-change",$.proxy(this._onServerUIChange,this)),Hub.sub("server-pen-change",$.proxy(this._onServerPenChange,this))},_onKey:function(e,t){t.key==="esc"&&this._hideSettingsPane()},_onServerUIChange:function(e,t){("settingsPanes"in t.ui||"externalInputs"in t.ui)&&this.controller.syncWithServer(t)},_onServerPenChange:function(e,t){this.controller.setPenValue(t)},_disableUI:function(){this._enabled=!1,this.$allEls.attr("disabled",!0)},_enableUI:function(){this._enabled=!0,this.$allEls.attr("disabled",!1)},_toggleSettingsPane:function(){this._enabled&&this.controller.toggleSettingsPane()},_hideSettingsPane:function(e){if(this._enabled&&this._notPartOfTypeahead(e)){var t={type:this.type};this.controller.hideSettingsPane(t)}},_notPartOfTypeahead:function(e){return e?$(e.target).closest(".tt-suggestion").length===0:!0},_buildBasicData:function(e){return{origin:"client",pen:e}}});"use strict";var BaseSettingsModel=Class.extend({type:"",OPEN:"open",CLOSED:"closed",init:function(){this._setSettingsPane(this.CLOSED),this._setExternalInputsCount()},_setExternalInputsCount:function(){var e=CP.pen[this.type+"_external"];e&&(CP.ui.externalInputs[this.type]=ExternalsUtil.getExternalsLength(e))},toggleSettingsPane:function(){this._updateAttributeState(),this._pubUISettingsChange()},_updateAttributeState:function(){var e=this._getSettingsPaneState(),t=this._getToggledPaneState(e);this._setSettingsPane(t)},_getToggledPaneState:function(e){return e===this.OPEN?this.CLOSED:this.OPEN},hideSettingsPane:function(){this._setSettingsPane(this.CLOSED),this._pubUISettingsChange()},setSettingsPaneState:function(e){this._setSettingsPane(e.value),this._pubUISettingsChange()},_getSettingsPaneState:function(){return CP.ui.settingsPanes[this.type]},_setSettingsPane:function(e){CP.ui.settingsPanes[this.type]=e},syncWithServer:function(e){var t;for(t in e.ui.settingsPanes)CP.ui.settingsPanes[t]=e.ui.settingsPanes[t],this._pubUISettingsChange();for(t in e.ui.externalInputs)e.ui.externalInputs[t]&&(CP.ui.externalInputs[t]=e.ui.externalInputs[t],this._pubExternalResourceChange())},_pubUISettingsChange:function(){var e={ui:{settingsPanes:{}}};e.ui.settingsPanes[this.type]=this._getSettingsPaneState(),Hub.pub("ui-change",e)},addExternalResource:function(){CP.ui.externalInputs[this.type]+=1,this._pubExternalResourceChange()},_pubExternalResourceChange:function(){var e={ui:{externalInputs:{}}};e.ui.externalInputs[this.type]=CP.ui.externalInputs[this.type],Hub.pub("ui-change",e)}});"use strict";var BaseSettingsView=Class.extend({OPEN:"open",CLOSED:"closed",type:"",_enabled:!0,init:function(){this._baseBindToHub(),this._syncExternalInputs()},_syncExternalInputs:function(){for(var e in CP.ui.externalInputs){var t=CP.ui.externalInputs[e];this._syncExternalInputsToModel(t),this._setExternalInputsCount(e)}},_setExternalInputsCount:function(e){var t=CP.pen[e+"_external"];if(t){var n=ExternalsUtil.getExternalsAsArray(t);$("."+e+"-resource").each(function(e,t){t=$(t),t.val()!==n[e]&&t.val(n[e])})}},_baseBindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChangeBase,this)),Hub.sub("ui-change",$.proxy(this._onUIChangeBase,this)),Hub.sub("ui-disable",$.proxy(this._disableUI,this)),Hub.sub("ui-enable",$.proxy(this._enableUI,this))},_disableUI:function(){this._enabled=!1,this._disableInputs()},_disableInputs:function(){$("."+this.type+"-resource").attr("disabled",!0)},_enableUI:function(){this._enabled=!0,this._enableInputs()},_enableInputs:function(){$("."+this.type+"-resource").attr("disabled",!1)},_onPenChangeBase:function(){this._setExternalInputsCount(this.type)},_onUIChangeBase:function(e,t){var n;if(this._isSettingPaneTypeChange(t))for(n in t.ui.settingsPanes){var r=t.ui.settingsPanes[n];this._updateSettingsPaneState(n,r)}if("externalInputs"in t.ui)for(n in t.ui.externalInputs)if(n===this.type){var i=t.ui.externalInputs[n];this._syncExternalInputsToModel(i)}},_isSettingPaneTypeChange:function(e){return e.ui&&e.ui.settingsPanes?!0:!1},_updateSettingsPaneState:function(e,t){t==="open"?($("#settings-"+e).addClass(this.OPEN),$("#settings-pane-"+e).addClass(this.OPEN)):($("#settings-"+e).removeClass(this.OPEN),$("#settings-pane-"+e).removeClass(this.OPEN))},_syncExternalInputsToModel:function(e){var t=e-$("."+this.type+"-resource").length;while(t>0)this._addExternalResourceInputEl(),t+=-1},_addExternalResourceInputEl:function(){var e=$("<div />",{"class":"external-resource-wrapper",html:this._getExternalResourceInputHTML(this.type)});this._appendExternalResourceInputEl(this.type,e)},_getExternalResourceInputHTML:function(e){var t=e==="css"?"style.css":"script.js",n=this._enabled?"":"disabled='disabled'";return"<input class='"+e+"-resource fullwidth external-resource' type='url' "+n+" placeholder='https://yourwebsite.com/"+t+"'><small class='error'>Must be a valid URL.</small>"},_appendExternalResourceInputEl:function(e,t){$("#external-"+e+"-resources > .external-resource-wrapper").last().after(t)},VALIDATE_URL_TIMEOUT:2e3,validateURLTimeoutID:0,hasURLError:!1,_validateExternalURLOnChangeGracefully:function(){var e=$(":focus");e.hasClass(this.type+"-resource")&&(clearTimeout(this.validateURLTimeoutID),this.validateURLTimeoutID=setTimeout($.proxy(function(){this._validateExternalURLOnChange(e.first())},this),this.VALIDATE_URL_TIMEOUT))},_validateExternalURLOnChange:function(e){_isValidURL(e.val())?e.next(".error").hide():e.next(".error").show().css("display","block")}});"use strict";var CSSSettingsController=BaseSettingsController.extend({type:"css",init:function(e){this.pen=e,this.events=new CSSSettingsEvents(this),this.model=new CSSSettingsModel,this.view=new CSSSettingsView(e)}});"use strict";var CSSSettingsEvents=BaseSettingsEvents.extend({type:"css",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='css-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$(".css-pre-processor-libs")._on("change",this._selectPreProcessorLib,this,!0),$("input[name='startercss']")._on("click",this._selectStartCSS,this,!0),$("input[name='prefix']")._on("click",this._selectCSSPrefix,this,!0)},_selectPreProcessor:function(e,t){var n=this._getSelectPreProcessorData(t);this.controller.setPenValue(n)},_getSelectPreProcessorData:function(e){var t=e.val(),n=$("#"+t+"-options"),r=n.length>0?n.val():"";return this._buildBasicData({css_pre_processor:t,css_pre_processor_lib:r})},_selectPreProcessorLib:function(e,t){var n=this._getSelectPreProcessorLibData(t);this.controller.setPenValue(n)},_getSelectPreProcessorLibData:function(e){return this._buildBasicData({css_pre_processor:e.data("css-pre-processor"),css_pre_processor_lib:e.val()})},_selectStartCSS:function(e,t){var n=this._buildBasicData({css_starter:t.val()});this.controller.setPenValue(n)},_selectCSSPrefix:function(e,t){var n=this._buildBasicData({css_prefix:t.val()});this.controller.setPenValue(n)}});"use strict";var CSSSettingsModel=BaseSettingsModel.extend({type:"css",init:function(){this._super()}});"use strict";var CSSSettingsView=BaseSettingsView.extend({boxCSSEl:$("#box-css"),type:"css",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"css_pre_processor"in e&&this._setPreProcessor(e),"css_pre_processor_lib"in e&&this._selectCSSPreProcessorLib(e),"css_starter"in e&&this._selectCSSStarter(e),"css_prefix"in e&&this._selectCSSPrefix(e)},_setPreProcessor:function(e){$("#box-css").hasClass("view-compiled")&&$("#CSS-view-compiled").click(),this._selectPreProcessor(e),this._addClassesToBoxCSS(e)},_selectPreProcessor:function(e){var t=":input[name='css-preprocessor'][value='"+e.css_pre_processor+"']";$(t).prop("checked",!0)},_addClassesToBoxCSS:function(e){this.boxCSSEl.removeClass("none scss sass less stylus").addClass(e.css_pre_processor)},_selectCSSPreProcessorLib:function(e){_.contains(["sass","scss","less","stylus"],e.css_pre_processor)&&$("#"+e.css_pre_processor+"-options").val(e.css_pre_processor_lib)},_selectCSSStarter:function(e){$("#startercss-options-form input[value='"+e.css_starter+"']").prop("checked",!0)},_selectCSSPrefix:function(e){$("#prefix-options-form input[value='"+e.css_prefix+"']").prop("checked",!0),this._addCSSPrefixClassToBoxCSS(e)},_addCSSPrefixClassToBoxCSS:function(e){this.boxCSSEl.removeClass("autoprefixer").addClass(e.css_prefix)}});"use strict";var ExternalsTypeahead=Class.extend({init:function(){__mobile||(this._bindToDOM(),this._bindToHub())},_bindToDOM:function(){$("#external-js, #external-css").one("click",$.proxy(this._onClickIntoExternalResourceInput,this))},_onClickIntoExternalResourceInput:function(e){this._bindToInputBoxes(),$(e.target).focus()},_bindToHub:function(){Hub.sub("ui-change",$.proxy(this._onUIChange,this))},_onUIChange:function(e,t){"externalInputs"in t.ui&&this._bindToInputBoxes()},_bindToInputBoxes:function(){$(".external-resource").off("typeahead:selected").on("typeahead:selected",function(){$(this).trigger("change")}),this._bindJSExternalsToTypeAhead(),this._bindCSSExternalsToTypeAhead()},_bindJSExternalsToTypeAhead:function(){var e=this;$(".js-resource").each(function(t,n){n=$(n),n.data("typeahead-bound")||(n.typeahead({name:"js_libs",prefetch:"/assets/editor/other/cdn/cdnjs_data.json",limit:5,template:e.typeaheadTemplate,engine:e.templateEngine}),n.data("typeahead-bound",!0))})},_bindCSSExternalsToTypeAhead:function(){var e=this;$(".css-resource").each(function(t,n){n=$(n),n.data("typeahead-bound")||(n.typeahead({name:"css_libs",prefetch:"/assets/editor/other/cdn/cdncss_data.json",limit:5,template:e.typeaheadTemplate,engine:e.templateEngine}),n.data("typeahead-bound",!0))})},templateEngine:{compile:function(e){var t=_.template(e);return{render:function(e){return t(e)}}}},typeaheadTemplate:_.template("<p><%= name %><small><%= value %></small></p>")});"use strict";var ExternalsUtil={getExternalsLength:function(e){return this.getExternalsAsArray(e).length},getExternalsAsArray:function(e){var t=e||"";return _.compact(t.split(";"))}};"use strict";var HTMLSettingsController=BaseSettingsController.extend({type:"html",init:function(e){this.pen=e,this.events=new HTMLSettingsEvents(this),this.model=new HTMLSettingsModel(this),this.view=new HTMLSettingsView(e)}});"use strict";var HTMLSettingsEvents=BaseSettingsEvents.extend({type:"html",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='html-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$("#head-content")._on("keyup change",this._setHead,this,!0),$("#html-classes")._on("keyup change",this._setHTMLClasses,this,!0)},_selectPreProcessor:function(e,t){var n=this._buildBasicData({html_pre_processor:t.val()});this.controller.setPenValue(n)},_setHead:function(e,t){var n=this._buildBasicData({head:t.val()});this.controller.setPenValue(n)},_setHTMLClasses:function(e,t){var n=this._buildBasicData({html_classes:t.val()});this.controller.setPenValue(n)}});"use strict";var HTMLSettingsModel=BaseSettingsModel.extend({type:"html",init:function(){this._super()}});"use strict";var HTMLSettingsView=BaseSettingsView.extend({boxHTMLEl:$("#box-html"),htmlClassesEl:$("#html-classes"),headEl:$("#head-content"),type:"html",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"html_pre_processor"in e&&this._setPreProcessor(e.html_pre_processor),"head"in e&&this._setHead(e.head),"html_classes"in e&&this._setHTMLClasses(e.html_classes)},_setHead:function(e){this.headEl.val(e)},_setHTMLClasses:function(e){this.htmlClassesEl.val(e)},_setPreProcessor:function(e){$("#box-html").hasClass("view-compiled")&&$("#HTML-view-compiled").click(),this._addClassBoxHTML(e),this._selectPreProcessor(e)},_selectPreProcessor:function(e){var t=":input[name='html-preprocessor'][value='"+e+"']";$(t).prop("checked",!0)},_addClassBoxHTML:function(e){this.boxHTMLEl.removeClass("none slim jade haml markdown").addClass(e)}});"use strict";var JSSettingsController=BaseSettingsController.extend({type:"js",init:function(e){this.pen=e,this.events=new JSSettingsEvents(this),this.model=new JSSettingsModel(this),this.view=new JSSettingsView(e)}});"use strict";var JSSettingsEvents=BaseSettingsEvents.extend({type:"js",init:function(e){this._super(e),this._bindToDOM()},_bindToDOM:function(){$("input[name='js-preprocessor']")._on("click",this._selectPreProcessor,this,!0),$("#js-select")._on("change",this._setJSLibrary,this,!0),$("#modernizr")._on("click",this._setJSModernizr,this,!0),$("#auto-run")._on("click",this._setAutoRun,this,!0)},_selectPreProcessor:function(e,t){var n=this._buildBasicData({js_pre_processor:t.val()});this.controller.setPenValue(n)},_setJSLibrary:function(e,t){var n=this._buildBasicData({js_library:t.val()});this.controller.setPenValue(n)},_setJSModernizr:function(e,t){var n=this._buildBasicData({js_modernizr:t.is(":checked")});this.controller.setPenValue(n)},_setAutoRun:function(e,t){var n=this._buildBasicData({auto_run:t.is(":checked")});this.controller.setPenValue(n)}});"use strict";var JSSettingsModel=BaseSettingsModel.extend({type:"js",init:function(){this._super()}});"use strict";var JSSettingsView=BaseSettingsView.extend({$boxJSEl:$("#box-js"),$autoRun:$("#auto-run"),$modernizr:$("#modernizr"),$body:$("body"),$jsSelect:$("#js-select"),type:"js",init:function(e){this._super(),this._bindToHub(),this._updateUI(e)},_bindToHub:function(){Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_onPenChange:function(e,t){this._updateUI(t.pen)},_updateUI:function(e){"js_pre_processor"in e&&this._setPreProcessor(e.js_pre_processor),"js_modernizr"in e&&this._selectJSModernizr(e.js_modernizr),"js_library"in e&&this._selectJSLibrary(e.js_library),"auto_run"in e&&this._setAutoRun(e.auto_run)},_setPreProcessor:function(e){$("#box-js").hasClass("view-compiled")&&$("#JS-view-compiled").click(),this._addClassBoxJS(e),this._selectPreProcessor(e)},_selectPreProcessor:function(e){var t=":input[name='js-preprocessor'][value='"+e+"']";$(t).prop("checked",!0)},_addClassBoxJS:function(e){this.$boxJSEl.removeClass("none coffeescript livescript").addClass(e)},_selectJSLibrary:function(e){this.$jsSelect.val(e)},_selectJSModernizr:function(e){e&&this.$modernizr.prop("checked",!0)},_setAutoRun:function(e){e?(this.$autoRun.prop("checked",!0),this.$body.removeClass("show-run-button")):(this.$autoRun.prop("checked",!1),this.$body.addClass("show-run-button"))}});"use strict";var ShareGist=Class.extend({WAITING_MSG_TIMEOUT:1e4,GIST_MSG_TIMEOUT:7e3,init:function(e){_.extend(this,AJAXUtil),this._shareView=e,this._bindToDOM()},_bindToDOM:function(){$("#share-gist")._on("click",$.proxy(this._createGist,this))},_createGist:function(){this._shareView.hideShareView(),$.showMessage(Copy.waitingForGist,this.WAITING_MSG_TIMEOUT);var e=CP.profiled.base_url+"/share/gist.json";this.post(e,{data:JSON.stringify(CP.pen)},this._doneCreateGist)},_doneCreateGist:function(e){var t=_.template(Copy.gistCreated,{url:e.url});$.showMessage(t,this.GIST_MSG_TIMEOUT),window.open(e.url)}});"use strict";var ShareSMS=Class.extend({$sendToPhone:$("#send-to-phone"),$sendToPhoneForm:$("#send-to-phone-form"),$sendButton:$("#sms-send-button"),$smsPhone:$("#sms-phone"),$errorMessage:$(".error-message"),$textsLeft:$("#texts-left"),init:function(e){_.extend(this,AJAXUtil),this._shareView=e,this._bindToDOM(),this._loadSMSPhoneNumberFromCookie()},_bindToDOM:function(){this.$sendToPhoneForm._on("submit",this.sendSMS,this)},_loadSMSPhoneNumberFromCookie:function(){$.cookie("sms_phone_number")&&this.$sendToPhone.val($.cookie("sms_phone_number"))},sendSMS:function(){this.$sendButton.prop("disabled",!0);var e=CP.profiled.base_url+"/share/sms/"+CP.pen.slug_hash,t={phone_number:this.$sendToPhone.val()};this.post(e,t,this._doneSendSMS,this._failedSendSMS)},_doneSendSMS:function(e){this._shareView.hideShareView(),this._clearSMSErrors(),this._setSMSPhoneNumberCookie(e),this.$sendButton.prop("disabled",!1),this.$textsLeft.html(e.sms_left),$.showMessage(_.template(Copy.smsSentTo,{phone_number:e.phone_number}),"slow")},_setSMSPhoneNumberCookie:function(e){var t={expires:30,domain:this.getAllDomain(),path:"/"};$.cookie("sms_phone_number",e.phone_number,t)},getAllDomain:function(){return"."+document.location.host},_failedSendSMS:function(e){this._clearSMSErrors(),this.$sendButton.prop("disabled",!1),this.$smsPhone.addClass("error"),this.$smsPhone.append(this._getErrorsHTML(e))},_getErrorsHTML:function(e){var t="";for(var n in e.errors)t+="<div class='error-message'>"+e.errors[n]+"</div>";return t},_clearSMSErrors:function(){this.$smsPhone.removeClass("error"),this.$errorMessage.remove()}});"use strict";var ShareView=Class.extend({$sharingButton:$("#sharing-button"),$sharingPanel:$("#sharing-panel"),$shareButtons:$("#share-buttons"),init:function(){_.extend(this,AJAXUtil),this.pageType=__pageType,this.shareSMS=new ShareSMS(this),this.shareGist=new ShareGist(this),this._bindToDOM(),this._bindToHub(),this._updateRoomLinks()},_bindToHub:function(){Hub.sub("key",$.proxy(this._onKey,this)),Hub.sub("pen-change",$.proxy(this._onPenChange,this))},_bindToDOM:function(){this.$sharingButton._on("click",this._toggleSharePane,this),_hideElementWhenUserClicksAway("#sharing-panel",$.proxy(this.hideShareView,this)),$("#sharing-panel > *").on("click",function(e){e.stopPropagation()})},_onKey:function(e,t){t.key==="esc"&&this.hideShareView()},_toggleSharePane:function(e){this.$sharingPanel.slideToggle(100,function(){$(this).css("overflow","visible")}),this._hideOtherElements(),this._loadSharingButtons()},_hideOtherElements:function(){$.hideMessage(),CP.infoController&&CP.infoController.hideOnly()},_loadSharingButtons:function(){!this._sharingButtonsLoaded()&&this.pageType!=="details"&&$.get("/ajax/social/modules",$.proxy(function(e){this.$shareButtons.html(e.html)},this))},_sharingButtonsLoaded:function(){return this.$shareButtons.children().length>0},hideShareView:function(){this.$sharingButton.removeClass("active"),this.$sharingPanel.hide()},_onPenChange:function(e,t){t.pen.private&&this._updateRoomLinks()},_updateRoomLinks:function(){$("#editor-link").attr("href",this._getViewURL("pen")),$("#details-link").attr("href",this._getViewURL("details")),$("#full-page-link").attr("href",this._getViewURL("full")),$("#full-page-url").val(URLBuilder.getShortViewURL("",CP.pen)),$("#live-view-link").attr("href",this._getViewURL("live")),$("#live-view-url").val(URLBuilder.getShortViewURL("v",CP.pen));var e=this._getViewURL("collab");$("#collab-view-link").attr("href",e),$("#collab-link").attr("href",e),$("#collab-view-url").val(URLBuilder.getShortViewURL("c",CP.pen));var t=this._getViewURL("professor");$("#professor-view-link").attr("href",t),$("#professor-link").attr("href",t),$("#professor-view-url").val(URLBuilder.getShortViewURL("p",CP.pen)),$("#share-zip").attr("href",this._getViewURL("share/zip"))},_getViewURL:function(e){return URLBuilder.getViewURL(e,CP.profiled,CP.pen,!1)}}),Copy={penUpdated:"Pen Saved.",penForked:"We forked this Pen. It's saved to your account, but you can <a href='<%= url %>' target='_blank'>view it here.</a>",waitingForGist:"Creating GitHub Gist. Please be patient and stay awesome.",gistCreated:"Thanks for staying awesome. <a href='<%= url %>' target='_blank'> Here's a link to your Gist.</a>",youHaveUnsavedChanges:"You have NOT saved your pen. Stop and save if you want to keep your pen.",collectionSavedPenAdded:"Your collection '<%= name %>' was created and this pen was added to it. <a href='<%= url %>'>View collection</a>.",penAddToCollection:"This pen was added to the '<%= name %>' collection. <a href='<%= url %>'>View collection</a>.",smsSentTo:"Text sent to phone <%= phone_number %>.",pauseAndPlay:"Pause and Play",catchUpToClass:"Catch Up to Class",studentWatching:"Student Watching",studentsWatching:"Students Watching",unsubcribedFromCommentNotifications:"You've been unsubscribed from comments for this Pen",subscribedToCommentNotifications:"You've been subscribed to comments for this Pen",deletingPen:"Deleting this pen. Buckle up!",cleanErrorsFirst:"There are errors that must be cleared first.",viewSource:"View Source",returnToSource:"Return to Source",errors:{"waiting-to-save-pen":"Still waiting to save pen. Try saving again.","anon-cannot-save-empty-pen":"You cannot save an empty Pen. Make something beautiful.","anon-cannot-save-during-rt-session":"Please login to save this Pen.","unable-to-save-try-again":"Unable to save pen. Trying again for the <%= time %> time. Please be patient.","unable-to-save-ever":"Unable to save pen. Please contact support@codepen.io."}};"use strict";var CPFactory={buildDataObjects:function(){CP.pen=new Pen,CP.profiled=new Profiled,CP.user=new User,CP.ui=UI.buildDefaultUIData()},buildEditorObjects:function(){CP.penErrorHandler=new PenErrorHandler,CP.penResources=new PenResources,CP.penRenderer=new PenRenderer,CP.codeEditorAnalayze=new CodeEditorAnalyze,CP.htmlEditor=new HTMLEditor("html",CP.pen.html),CP.cssEditor=new CSSEditor("css",CP.pen.css),CP.jsEditor=new JSEditor("js",CP.pen.js),CP.infoController=new InfoController,CP.shareView=new ShareView,CP.htmlSettingsController=new HTMLSettingsController(CP.pen),CP.cssSettingsController=new CSSSettingsController(CP.pen),CP.jsSettingsController=new JSSettingsController(CP.pen)},buildDesktopViewEditorObjects:function(){CP.codeEditorResizeController=new CodeEditorsResizeController,CP.codeEditorsCSSTransitionHandler=new CodeEditorsCSSTransitionHandler,CP.codeEditorsViewSourceController=new CodeEditorsViewSourceController,CP.externalsTypeahead=new ExternalsTypeahead,CP.keyBindings=new KeyBindings}};"use strict";var HandleIFrameClicks={init:function(e){this.pen=e,this._bindToDOM()},_bindToDOM:function(){window.addEventListener?window.addEventListener("message",$.proxy(this.handleIFrameClickEvent,this),!1):window.attachEvent("onmessage",$.proxy(this.handleIFrameClickEvent,this))},handleIFrameClickEvent:function(e){if(this._allowedToOpenWindows()){var t=this._cleanURL(this._getURLFromEvent(e));t.match(/^https?:\/\/\S+$/)&&window.open(t)}},_allowedToOpenWindows:function(){return this.pen.user_id>1},_getURLFromEvent:function(e){return typeof e.data=="string"?e.data:""},_cleanURL:function(e){var t=this._getIFrameURLRemoved(e);return t=this._sanitizeURL(t),t=t.replace(/(java|vb)?script/gmi,""),t=t.replace(/eval/gmi,""),t=t.split("?")[0],t},_getIFrameURLRemoved:function(e){return e.replace(/http(s)?:\/\/(s\.)?codepen\.(dev|io)\/(boomerang\/\S+|\S+\/fullpage)\/\w+(\.html)?/m,"")},_sanitizeURL:function(e){return e.replace(/[^-A-Za-z0-9+&@#/%?=~_|!:,.;\(\)]/,"")}};"use strict";var Loader={loaded:[],files:{"analyze-js":"/assets/libs/jshint.js;/assets/editor/other/analyze.js","analyze-html":"/assets/libs/html-inspector.js;/assets/editor/other/analyze.js","analyze-css":"/assets/libs/csslint.js;/assets/editor/other/analyze.js",htmlparser:"/assets/libs/htmlparser.js",mode_xml:"",mode_markdown:"/assets/editor/other/mode/markdown/markdown.js",mode_haml:"/assets/editor/other/mode/htmlmixed/htmlmixed.js;/assets/editor/other/mode/ruby/ruby.js;/assets/editor/other/mode/haml/haml.js",mode_python:"/assets/editor/other/mode/python/python.js",mode_slim:"",mode_jade:"/assets/editor/other/mode/jade/jade.js","mode_text/css":"","mode_text/x-scss":"","mode_text/x-less":"","mode_text/x-sass":"/assets/editor/other/mode/sass/sass.js",mode_javascript:"",mode_coffeescript:"/assets/editor/other/mode/coffeescript/coffeescript.js",mode_livescript:"/assets/editor/other/mode/livescript/livescript.js"},run:function(e,t){if(this.loaded.indexOf(e)>-1)return t();var n=this.files[e].split(";");return this.loaded.push(e),this.loadJSLibraries(n,t)},loadJSLibraries:function(e,t){if(!(e.length>0))return t();var n=e.shift();$.getScript(n,$.proxy(function(){this.loadJSLibraries(e,t)},this))}};"use strict";var TimeUtil={countToString:function(e){var t={1:"first",2:"second",3:"third",4:"fourth",5:"fifth"};return e in t?t[e]:e}};"use strict";var TypesUtil={_HTML_TYPES:["html","xml","haml","markdown","slim","jade"],_CSS_TYPES:["css","less","scss","sass","stylus","text/css","text/x-sass","text/x-scss","text/x-less"],_JS_TYPES:["js","javascript","coffeescript","livescript"],cmModeToType:function(e){var t=this._getSafeInputMode(e);return this._getType(t)},_getSafeInputMode:function(e){var t=typeof e=="string"?e:e.name;return t.toLowerCase()},syntaxToType:function(e){return this._getType(e)},_getType:function(e){if(this._isHTMLType(e))return"html";if(this._isCSSType(e))return"css";if(this._isJSType(e))return"js";throw"Unknown type: '"+e+"'. Please contact support@codepen.io."},_isHTMLType:function(e){return _.contains(this._HTML_TYPES,e)},_isCSSType:function(e){return _.contains(this._CSS_TYPES,e)},_isJSType:function(e){return _.contains(this._JS_TYPES,e)}};"use strict";var Follow={init:function(){_.extend(this,AJAXUtil),this.profiled=__profiled,this._bindToDOM()},_bindToDOM:function(){this._addOnHoverChangeToFollowButton(),$("#follow-this-user, #following-this-user")._on("click",this.followThisUser,this)},_addOnHoverChangeToFollowButton:function(){$("#following-this-user").hover(function(){$(this).addClass("red").data("text-value",$(this).html()).html("<svg viewBox='0 0 100 100'><use xlink:href='#icon-x'></use></svg> Following")},function(){$(this).removeClass("red").html($(this).data("text-value"))})},followThisUser:function(){var e=this._getActionTypeTaken();this._updateFollowButtonImmediately(e),this.post(this._getFollowUnfollowURL(e),{},this._doneFollowThisUser)},_getActionTypeTaken:function(){return $("#follow-this-user").is(":visible")?"follow":"unfollow"},_getFollowUnfollowURL:function(e){var t="/follow/<%= type %>/<%= id %>/<%= action %>";return _.template(t,{type:this.profiled.type,id:this.profiled.id,action:e})},_updateFollowButtonImmediately:function(e){e==="follow"?($("#follow-this-user").hide(),$("#following-this-user").show()):($("#follow-this-user").show(),$("#following-this-user").hide())},_doneFollowThisUser:function(e){$("#followers-tab").hasClass("active")&&$("#followers").replaceWith(e.html)}};"use strict";var Drawer={drawer:$("#drawer"),drawerOpen:!1,drawerHasBeenOpened:!1,init:function(){this.bindUIEvents()},bindUIEvents:function(){$("#view-details-button")._on("click",this.toggleDrawer,this),$("#drawer").on("click","#drawer-close-button",this.closeDrawer)},toggleDrawer:function(){Drawer.drawerOpen?Drawer.closeDrawer():Drawer.drawerHasBeenOpened?Drawer.openDrawer():Drawer.setUpDrawer()},openDrawer:function(){Drawer.drawer.show(),setTimeout(function(){Drawer.drawer.addClass("open"),Drawer.drawerOpen=!0,Drawer.drawerHasBeenOpened=!0},10),typeof Assets.closeAssetsArea=="function"&&Assets.closeAssetsArea()},closeDrawer:function(){Drawer.drawer.removeClass("open"),setTimeout(function(){Drawer.drawer.hide(),Drawer.drawerOpen=!1},301)},setUpDrawer:function(){var e=window.location.href,t=e.replace("/pen/","/drawer/");$.when($.get(t,function(e){Drawer.drawerContent=e}),$.get("/assets/details/drawer.css",function(e){$("<style></style>").appendTo("head").html(e)}),$.getScript("/assets/details/comment.js")).then(function(){Drawer.drawer.append(Drawer.drawerContent),Drawer.openDrawer(),Comment.init(),Follow.init()})}};Drawer.init(),"use strict";var LiveRoom=Class.extend({WAIT_TO_RUN_FIRST_LIVE_UPDATE:1e3,init:function(e,t){this.rtClient=e,this.rtData=t,_.extend(this,AJAXUtil),this._shouldJoinRoom(t)&&this.rtClient.connect(t,$.proxy(this._onConnect,this),_.noop)},_shouldJoinRoom:function(e){return e.role==="editor"&&e.pen.slugHash},_onConnect:function(){this._subscribeToLocalEvents(),this._subscribeToServerEvents(),this._publishFirstLiveUpdate()},_subscribeToLocalEvents:function(){Hub.sub("live_change",$.proxy(this._publishLiveUpdate,this))},_subscribeToServerEvents:function(){this.rtClient.subscribe("publishToNewClients",this.rtData,$.proxy(this._publishToNewClients,this))},_publishToNewClients:function(){setTimeout($.proxy(function(){this._publishFirstLiveUpdate()},this),this.WAIT_TO_RUN_FIRST_LIVE_UPDATE)},_publishFirstLiveUpdate:function(){this._publishLiveUpdate(null,CP.penRenderer.buildRenderablePen())},_publishLiveUpdate:function(e,t){this.rtClient.publish("liveUpdate",this.rtData,{pen:t})}});"use strict";var MiniEmbedBuilder={builder:"",overlay:$("#overlay"),builderButton:$(".embed-builder-button"),init:function(){_.extend(this,AJAXUtil),this.bindToDOM()},bindToDOM:function(){this.builderButton._on("click",this.showMiniEmbedBuilder,this),this.overlay._on("click",this.hideBuilder,this)},showMiniEmbedBuilder:function(){this.alreadyLoadedMiniEmbedBuilder()?this.showBuilder():this.getMiniEmbedBuilder()},alreadyLoadedMiniEmbedBuilder:function(){return this.builder!==""},getMiniEmbedBuilder:function(){var e={username:CP.profiled.username,slugHash:CP.pen.slug_hash},t=_.template("/<%= username %>/embed/mini/builder/<%= slugHash %>",e);this.get(t,{},this.doneGetMiniEmbedBuilder)},doneGetMiniEmbedBuilder:function(e){this.addMiniEmbedBuilderAndShow(e),this.addMiniEmbedBuilderCSSAndJS(e)},addMiniEmbedBuilderAndShow:function(e){this.addMiniEmbedBuilderHTMLToPage(e),this.showBuilder(),this.bindToMiniEmbedBuilderDOM()},addMiniEmbedBuilderHTMLToPage:function(e){this.builder=$("<div />",{id:"embed-builder","class":"embed-builder loading",html:e.html}).appendTo("body")},bindToMiniEmbedBuilderDOM:function(){$("#embed-builder-close-button")._on("click",this.hideBuilder,this),Keytrap.bind("esc",$.proxy(this.hideBuilder,this))},addMiniEmbedBuilderCSSAndJS:function(){$.ajax({url:"/assets/embed/embed-builder.css",cache:!1,success:function(e){$("<style></style>").appendTo("head").html(e),$.getScript("/assets/embed/builder/embed_builder.js")}})},showBuilder:function(){this.builder.addClass("open"),this.overlay.show()},hideBuilder:function(){this.builder.removeClass("open loading"),this.overlay.hide()}};MiniEmbedBuilder.init(),"use strict",$.event.props.push("dataTransfer");var Assets={s:{doc:$(document),allFiles:$("#assets-all-files"),assetsLink:$("#assets-link"),assetsArea:$("#assets-area"),assetsWrap:$("#assets-wrap"),searchField:$("#assets-search"),assetsOpen:!1,otherList:$("#assets-other-files").find("ol"),manualInput:$("#manual-file-upload"),dragPrevent:!1,openingLock:!1,files:[]},init:function(){this.bindUIActions(),_.extend(this,AssetsSign),_.extend(this,AJAXUtil)},bindUIActions:function(){Assets.s.assetsLink._on("click",function(e){Assets.s.assetsOpen?Assets.closeAssetsArea():Assets.openAssetsArea()}),$("#assets-area-close-button")._on("click",Assets.closeAssetsArea,this),Keytrap.bind("esc",function(){Assets.closeAssetsArea()});var e;Assets.s.assetsArea._on("dragenter dragover",function(t){clearTimeout(e),!Assets.s.dragPrevent&&Assets.testIfContainsFiles(t)&&Assets.makeLookDroppable
()}),Assets.s.assetsArea._on("dragleave dragout",function(t){e=setTimeout(function(){Assets.unmakeLookDroppable()},200)}),Assets.s.assetsArea._on("drop",function(e){e.preventDefault(),Assets.testIfContainsFiles(e)&&Assets.handleFileDrop(e)}),Assets.s.allFiles.on("click",".single-asset",function(e){Assets.showFilePath(e,this),Assets.s.dragPrevent=!0;var t=$(e.target);t.val("https://s3-us-west-2.amazonaws.com/s.cdpn.io/"+(__team_id===0?__user.id:"t-"+__team_id)+"/"+t.data("file-name"))}),Assets.s.allFiles.on("mouseleave mouseout",".file-input",function(e){var t=this;setTimeout(function(){Assets.hideFilePath(e,t),Assets.s.dragPrevent=!1},350)}),Assets.s.allFiles.on("click",".file-delete",function(e){Assets.deleteFile(e,this)}),Assets.s.manualInput._on("change",Assets.handleFileSelect),Assets.s.searchField._on("keydown click",Assets.search,this,!0)},testIfContainsFiles:function(e){if(e.dataTransfer.types)for(var t=0;t<e.dataTransfer.types.length;t++)if(e.dataTransfer.types[t]==="Files")return!0;return!1},openAssetsArea:function(){Assets.s.openingLock=!0,Assets.getAssets(),Assets.s.assetsWrap.show(),setTimeout(function(){Assets.s.assetsWrap.addClass("open")},10),Assets.s.assetsOpen=!0,setTimeout(function(){Assets.s.openingLock=!1},1e3),typeof Drawer.closeDrawer=="function"&&Drawer.closeDrawer()},closeAssetsArea:function(){Assets.s.assetsWrap.removeClass("open"),setTimeout(function(){Assets.s.assetsWrap.hide()},301),Assets.s.assetsOpen=!1},makeLookDroppable:function(){Assets.s.assetsArea.addClass("draggedOn")},unmakeLookDroppable:function(){Assets.s.assetsArea.removeClass("draggedOn")},handleFileDrop:function(e){Assets.processFile(e.dataTransfer.files),Assets.unmakeLookDroppable()},handleFileSelect:function(e){Assets.processFile(e.target.files)},assetUploadComplete:function(e){var t=Assets.s.files[e.base_name],n=$("<li />",{html:e.markup,"class":"newly-added single-asset",id:"asset-"+e.id});$("#progress").html(e.progress),t.type.match("image.*")?(n.prependTo("#file-list-image"),Assets.removeEmptyFilesListItem("#file-list-image")):t.type.match("text/css")?(n.prependTo("#file-list-css"),Assets.removeEmptyFilesListItem("#file-list-css")):t.type.match("text/javascript")?(n.prependTo("#file-list-javascript"),Assets.removeEmptyFilesListItem("#file-list-javascript")):(n.prependTo("#file-list-other"),Assets.removeEmptyFilesListItem("#file-list-other")),setTimeout(function(){n.removeClass("newly-added")},50),Assets.decrementFileCount(),Assets.numFiles===0&&Assets.uploadFinalize()},friendlyFileSize:function(e){var t=Math.round(e/1e3);return t>1e3?t.to_fixed(2)+"m":t+"K"},urlBuilder:function(){return"http://s.cdpn.io/r"},decrementFileCount:function(){--Assets.numFiles},processFile:function(e){var t,n=e.length;Assets.numFiles=n,Assets.errors=[];if(n>10)$.showModal("/ajax/assets/too_many_files","modal-error");else{var r=!1,i=!1;for(t=0;t<n;t++)e[t].size>2097152&&(r=!0),e[t].name.match(/^.+\.(exe|other_bad_extension)$/)&&(i=!0),e[t].name.match(/^.+\..+$/)||(i=!0);if(r)$.showModal("/ajax/assets/file_too_big","modal-error"),_trackEvent("Assets","Upload","Fail - Too big of file");else if(i)$.showModal("/ajax/assets/bad_extension","modal-error"),_trackEvent("Assets","Upload","Fail - bad extension");else{for(t=0;t<n;t++)Assets.s.files[e[t].name.split(" ").join("_")]=e[t],AssetsSign.signAsset(e[t],Assets.assetUploadComplete,Assets.assetUploadFailed);_trackEvent("Assets","Upload","Success")}}},assetUploadFailed:function(e){Assets.decrementFileCount(),Assets.deleteFileAjax(e.rslt.id);var t=/<Code>(.+)<\/Code>/i.exec(e.responseText)[1];Assets.errors.push({code:t,file:e.rslt.base_name}),Assets.numFiles===0&&Assets.uploadFinalize()},uploadFinalize:function(){Assets.errors.length>0&&$.showModal("/ajax/assets/upload_errors?errors="+JSON.stringify(Assets.errors),"modal-error")},removeEmptyFilesListItem:function(e){$(""+e).find(".no-files").remove()},resetFileInput:function(){Assets.s.manualInput.replaceWith(Assets.s.manualInput.val("").clone(!0))},showFilePath:function(e,t){e.preventDefault();var n=$(t).find(".file-input");n.css("display")==="none"?n.show().select():setTimeout(function(){n.select()},40)},hideFilePath:function(e,t){$(t).hide()},deleteFile:function(e,t){e.preventDefault();var n=$(t).data("asset-id");$.showModal("/ajax/assets/confirm_asset_delete","modal-warning",$.proxy(function(){this.doneConfirmDeleteAsset(n)},this))},doneConfirmDeleteAsset:function(e){$("#confirm-delete")._on("click",function(){this.finishDeletingAsset(e)},this)},finishDeletingAsset:function(e){$.hideMessage(),Assets.deleteFileAjax(e)},deleteFileAjax:function(e){this.del("/static/assets/"+e,{},Assets.doneDeleteFileAjax)},doneDeleteFileAjax:function(e){var t=$("#asset-"+e.id);t.siblings().length===0&&t.parent().append("<li class='no-files'>There are no files of this type&nbsp;yet.</li>"),t.addClass("deleting").slideUp(250,function(){t.remove()})},getAssets:function(){this.post("/static/assets",{},Assets.doneGetAssets)},doneGetAssets:function(e){$("#assets-all-files").html(e.asset_list);var t=$(e.progress);$("#progress").html(e.progress),$("#progress").attr("title",t.attr("title"))},assetsUploadFailed:function(){$.showModal("/ajax/assets/generic_fail","modal-warning")},search:function(e,t){var n=t.val();$(".single-asset").hide(),$(".single-asset:contains('"+n+"')").show()}};"use strict";var AssetsSign={init:function(){_.extend(this,AJAXUtil)},signAsset:function(e,t,n){var r=Math.round(e.size/1e3);r===0&&(r=1),this.post("/static/sign_asset",{contentType:e.type,fileName:e.name.split(" ").join("_"),fileKB:r},function(r){AssetsSign.doneSign(r,e,t,n)})},signProfileNew:function(e,t){var n={};for(var r=0;r<e.length;r++){var i=AssetsSign.dataURItoBlob(e[r].data),s=Math.round(i.size/1e3);s===0&&(s=1),e[r]={dimension:e[r].dimension,size:s,data:i},n["sizes["+e[r].dimension+"]"]=s}this.post("/static/sign_profile/"+t,n,function(t){AssetsSign.doneSignProfile(t,e)})},doneSignProfile:function(e,t){for(var n=0;n<t.length;n++)AssetsSign.doneSign(e[t[n].dimension],t[n].data,AssetsSign.profileReallyDone)},profileReallyDone:function(e){},dataURItoBlob:function(e){var t=atob(e.split(",")[1]),n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(var i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return new Blob([n],{type:"image/jpeg"})},doneSign:function(e,t,n,r){var i=AssetsSign.getXHRObject(e,n,r),s=new FormData;for(var o in e.form_data)s.append(o,e.form_data[o]);s.append("file",t),i.open("POST",e.url,!0),i.send(s)},getXHRObject:function(e,t,n){var r=new XMLHttpRequest;return r.rslt=e,"withCredentials"in r||(r=null),r.onreadystatechange=function(){r.readyState===4&&(r.status===201?t(r.rslt):typeof n!="undefined"&&n(r))},r}};AssetsSign.init(),CPFactory.buildDataObjects(),CPFactory.buildEditorObjects(),CPFactory.buildDesktopViewEditorObjects(),CP.collections=new Collections,CP.penDelete=new PenDelete,CP.upsell=new Upsell;var rtClient=new RTClient;CP.liveRoom=new LiveRoom(rtClient,_.clone(__rtData)),Assets.init(),Hub.pub("page-loading-done"),Layout.doneLoading();